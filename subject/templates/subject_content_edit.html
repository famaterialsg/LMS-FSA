{% extends 'base.html' %}

{% block title %}Edit Content for {{ subject.name }}{% endblock %}

{% block content %}
<h1>Edit Content for {{ subject.name }}</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <h2>Documents</h2>
    <ul>
        {% for document in documents %}
            <li>
                <a href="{{ document.doc_file.url }}">{{ document.doc_title }}</a>
                <input type="checkbox" name="delete_document_{{ document.id }}"> Delete
            </li>
        {% empty %}
            <li>No documents available.</li>
        {% endfor %}
    </ul>

    <h2>Videos</h2>
    <ul>
        {% for video in videos %}
            <li>
                <a href="{{ video.vid_file.url }}">{{ video.vid_title }}</a>
                <input type="checkbox" name="delete_video_{{ video.id }}"> Delete
            </li>
        {% empty %}
            <li>No videos available.</li>
        {% endfor %}
    </ul>

    <h2>Reading Materials</h2>
    <div id="reading-materials-container">
        {% if reading_materials %}
            <h4>Existing Reading Materials</h4>
            <ul>
                {% for reading_material in reading_materials %}
                    <li>
                        <input type="checkbox" name="delete_reading_material_{{ reading_material.id }}" id="delete_reading_material_{{ reading_material.id }}">
                        <label for="delete_reading_material_{{ reading_material.id }}">Delete</label>
                        <strong>{{ reading_material.title }}</strong>
                        <p>{{ reading_material.content|safe }}</p>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <li>No reading materials available.</li>
        {% endif %}
        <h4>Add New Reading Materials</h4>
        <div id="reading-materials">
            <div class="reading-material-entry">
                <input type="text" name="reading_material_title[]" class="form-control" placeholder="Reading Material Title (optional)">
                <textarea name="reading_material_content[]" class="form-control ckeditor" placeholder="Reading Material Content (optional)"></textarea>
            </div>
        </div>
        <p class="text-muted">Leave fields blank if you do not wish to add new reading materials.</p>
        <button type="button" id="add-reading-material" class="btn btn-secondary mt-2">Add Another Reading Material</button>
    </div>

    <h3>Add New Content</h3>

    <div>
        <h4>Upload Documents</h4>
        <div id="document-container">
            <div class="document-entry">
                <input type="text" name="doc_title[]" class="form-control" placeholder="Document Title">
                <input type="file" name="doc_file[]" class="form-control-file" accept=".pdf,.doc,.docx,.ppt,.pptx">
                <button type="button" class="btn btn-danger delete-document" style="margin-left: 10px;">Delete</button>
            </div>
        </div>
        <button type="button" id="add-document" class="btn btn-secondary mt-2">Add Another Document</button>
    </div>

    <div>
        <h4>Upload Videos</h4>
        <div id="video-container">
            <div class="video-entry">
                <input type="text" name="vid_title[]" class="form-control" placeholder="Video Title">
                <input type="file" name="vid_file[]" class="form-control-file" accept="video/*">
                <button type="button" class="btn btn-danger delete-video" style="margin-left: 10px;">Delete</button>
            </div>
        </div>
        <button type="button" id="add-video" class="btn btn-secondary mt-2">Add Another Video</button>
    </div>

    <button type="submit" class="btn btn-primary">Save</button>
    <a href="{% url 'subject:subject_content' subject.pk %}" class="btn btn-secondary">Back to Subject Content</a>
</form>

{% block extra_js %}
<script src="https://cdn.ckeditor.com/4.16.0/standard/ckeditor.js"></script>
<script>
    // CKEditor initialization for existing textareas
    document.querySelectorAll('.ckeditor').forEach(function(textarea) {
        CKEDITOR.replace(textarea.name, {
            height: 300
        });
    });

    // Function to add a new reading material entry
    document.getElementById('add-reading-material').addEventListener('click', function() {
        const container = document.getElementById('reading-materials');
        const newEntry = document.createElement('div');
        newEntry.className = 'reading-material-entry';
        newEntry.innerHTML = `
            <input type="text" name="reading_material_title[]" class="form-control" placeholder="Reading Material Title" required>
            <textarea name="reading_material_content[]" class="form-control ckeditor" required></textarea>
        `;
        container.appendChild(newEntry);
        // Initialize CKEditor for the new textarea after it's added
        CKEDITOR.replace(newEntry.querySelector('textarea').name, {
            height: 300
        });
    });

    // Document and video addition code remains unchanged
    function addDocumentEntry() {
        const container = document.getElementById('document-container');
        const newEntry = document.createElement('div');
        newEntry.className = 'document-entry';
        newEntry.innerHTML = `
            <input type="text" name="doc_title[]" class="form-control" placeholder="Document Title">
            <input type="file" name="doc_file[]" class="form-control-file" accept=".pdf,.doc,.docx,.ppt,.pptx">
            <button type="button" class="btn btn-danger delete-document" style="margin-left: 10px;">Delete</button>
        `;
        container.appendChild(newEntry);
        attachDeleteButton(newEntry.querySelector('.delete-document'));
    }

    function addVideoEntry() {
        const container = document.getElementById('video-container');
        const newEntry = document.createElement('div');
        newEntry.className = 'video-entry';
        newEntry.innerHTML = `
            <input type="text" name="vid_title[]" class="form-control" placeholder="Video Title">
            <input type="file" name="vid_file[]" class="form-control-file" accept="video/*">
            <button type="button" class="btn btn-danger delete-video" style="margin-left: 10px;">Delete</button>
        `;
        container.appendChild(newEntry);
        attachDeleteButton(newEntry.querySelector('.delete-video'));
    }

    function attachDeleteButton(button) {
        button.addEventListener('click', function() {
            const entry = this.parentNode;
            entry.parentNode.removeChild(entry);
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('add-document').addEventListener('click', addDocumentEntry);
        document.getElementById('add-video').addEventListener('click', addVideoEntry);
        document.querySelectorAll('.delete-document').forEach(button => {
            attachDeleteButton(button);
        });
        document.querySelectorAll('.delete-video').forEach(button => {
            attachDeleteButton(button);
        });
    });
</script>
{% endblock %}
{% endblock %}
