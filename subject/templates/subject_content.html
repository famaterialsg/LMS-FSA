{% extends 'base.html' %}
{% load form_filters %}

{% block title %}Subject Content{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Left Column (Subject Information) -->
        <div class="col-md-3" style="margin-left: 2cm; margin-right: 2cm;">
            <h2 class="text-xl font-semibold mb-4">Subject Information</h2>
            <h3 class="text-lg font-semibold mb-2">Documents</h3>
            {% if documents %}
                <ul class="list-group mb-4">
                    {% for document in documents %}
                    <li class="list-group-item {% if document == current_item %}active{% endif %}">
                        <a href="{% url 'subject:subject_content' subject.pk %}?file_id={{ document.id }}&file_type=document">{{ document.doc_title }}</a>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mb-4">No documents available for this subject.</p>
            {% endif %}

            <h3 class="text-lg font-semibold mb-2">Videos</h3>
            {% if videos %}
                <ul class="list-group mb-4">
                    {% for video in videos %}
                        <li class="list-group-item {% if video == current_item %}active{% endif %}">
                            <a href="{% url 'subject:subject_content' subject.pk %}?file_id={{ video.id }}&file_type=video">{{ video.vid_title }}</a>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mb-4">No videos available for this subject.</p>
            {% endif %}

            <h3 class="text-lg font-semibold mb-2">Reading Materials</h3>
            {% if reading_materials %}
                <ul class="list-group mb-4">
                    {% for reading in reading_materials %}
                    <li class="list-group-item {% if reading == current_item %}active{% endif %}">>
                        <a href="{% url 'subject:subject_content' subject.pk %}?file_id={{ reading.id }}&file_type=reading">{{ reading.title }}</a>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="mb-4">No reading materials available for this subject.</p>
            {% endif %}

            <a href="{% url 'subject:subject_list' %}" class="btn btn-secondary">Return to Subject List</a>
        </div>

        <!-- Right Column (File Preview) -->
        <div class="col-md-7">
            <h2 class="text-2xl font-bold mb-4">File Preview</h2>
            <div id="preview-content" class="preview-container border p-3">
                {% if preview_url %}
                    {% if content_type == 'video' %}
                        <video controls class="w-100">
                            <source src="{{ preview_url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% elif content_type == 'image' %}
                        <img src="{{ preview_url }}" alt="Image preview" class="img-fluid">
                    {% elif content_type == 'pdf' %}
                        <iframe src="{{ preview_url }}" style="width: 100%; height: 600px;" frameborder="0"></iframe>
                    {% elif content_type == 'reading' %}
                    <h3>{{ current_item.title }}</h3>
                        <div class="reading-material-content">
                            {{ preview_content|safe }}
                        </div>
                    {% endif %}
                {% elif download_url %}
                    <p>This file type cannot be previewed. <a href="{{ download_url }}" class="btn btn-primary">Download File</a></p>
                {% else %}
                    <p>Select a file from the left to preview or download it.</p>
                {% endif %}
            </div>
            <div class="mt-3">
                {% if current_item %}
                    <button id="complete-btn" class="btn {% if completion_status %}btn-secondary{% else %}btn-success{% endif %}" data-subject-id="{{ subject.pk }}" data-file-type="{{ file_type }}" data-file-id="{{ file_id }}">
                        {% if completion_status %}
                            Completed
                        {% else %}
                            Mark as Complete
                        {% endif %}
                    </button>
                    {% if next_item_type and next_item_id %}
                        <button id="next-btn" class="btn btn-primary ml-2" data-next-item-type="{{ next_item_type }}" data-next-item-id="{{ next_item_id }}">
                            Next Item
                        </button>
                    {% endif %}
                {% endif %}
            </div>
            <div class="mb-4 mt-3">
                <a href="{% url 'subject:subject_content_edit' subject.pk %}" class="btn btn-primary">Edit Subject Content</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#complete-btn').click(function() {
        var button = $(this);
        var subjectId = button.data('subject-id');
        var fileType = button.data('file-type');
        var fileId = button.data('file-id');

        $.ajax({
            url: "{% url 'subject:toggle_completion' subject.pk %}",
            method: 'POST',
            data: {
                'file_type': fileType,
                'file_id': fileId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.completed) {
                    button.text('Completed');
                    button.removeClass('btn-success').addClass('btn-secondary');
                } else {
                    button.text('Mark as Complete');
                    button.removeClass('btn-secondary').addClass('btn-success');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
            }
        });
    });

    $('#next-btn').click(function() {
        var button = $(this);
        var nextItemType = button.data('next-item-type');
        var nextItemId = button.data('next-item-id');

        if (nextItemType && nextItemId) {
            window.location.href = "{% url 'subject:subject_content' subject.pk %}?file_id=" + nextItemId + "&file_type=" + nextItemType;
        }
    });
});
</script>
{% endblock %}