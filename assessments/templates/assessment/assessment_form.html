{% extends "base.html" %}

{% block title %}{% if assessment %}Edit Assessment{% else %}Create New Assessment{% endif %}{% endblock %}

{% block content %}
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

</head>

<div class="container mt-4">
    <h2 class="text-center mb-4">{% if assessment %}Edit Assessment{% else %}Create New Assessment{% endif %}</h2>

    {% if assessment.id %}
    <a href="{% url 'assessment:take_assessment' assessment_id=assessment.id %}" class="btn btn-secondary mb-3">Preview Assessment</a>
    {% endif %}

    <form method="POST" id="assessment-form">
        {% csrf_token %}

        <div class="card mb-4 shadow">
            <div class="card-header bg-primary text-white">
                <h4>Assessment Details</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <label for="id_assessment_type" class="form-label">Assessment Type</label>
                        {{ form.assessment_type }}

                    </div>
                    <div class="col-md-4">
                        <label for="id_title" class="form-label">Title</label>
                        {{ form.title }}

                    </div>
                    <div class="col-md-4">
                        <label for="id_course" class="form-label">Course</label>
                        {{ form.course }}
                        
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow">
            <div class="card-header bg-secondary text-white">
                <h4>Exercises/Questions/Settings</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="exercises-tab" data-bs-toggle="tab" data-bs-target="#exercises" type="button" role="tab" aria-controls="exercises" aria-selected="true">Exercises</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions" type="button" role="tab" aria-controls="questions" aria-selected="false">Questions</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
                    </li>
                </ul>

                <div class="tab-content mt-3" id="myTabContent">
                    <!-- Exercises Tab -->
                    {% include "assessment/exercises_tab.html" %}

                    <!-- Questions Tab -->
                    {% include "assessment/questions_tab.html" %}

                    <!-- Settings Tab -->
                    {% include "assessment/settings_tab.html" %}
                </div>

            </div>
        </div>


        <div class="text-center">
            <button type="submit" class="btn btn-success">Save Assessment</button>
            <a href="{% url 'assessment:assessment_list' %}" class="btn btn-secondary">Back to List</a>
        </div>
    </form>
</div>

<div id="fullscreen-preview" class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white" style="z-index: 1050;">
    <!-- Nội dung sẽ được chèn vào đây -->
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addQuestionButtons = document.querySelectorAll('.add-question');
        const selectedQuestionsList = document.getElementById('selected-questions');
        
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'd-flex justify-content-end mt-3';

        const saveButton = document.createElement('button');
        saveButton.className = 'btn btn-success btn-sm'; 
        saveButton.innerText = 'Save';
        saveButton.style.display = 'none'; 
        buttonContainer.appendChild(saveButton);
        selectedQuestionsList.parentElement.appendChild(buttonContainer);

        
        // Add event listener to each remove button
        const removeButtons = document.querySelectorAll('.remove-question');
        
        removeButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Get the question id from the button's data attribute
                const questionId = this.getAttribute('data-question-id');
                
                // Find the <li> element containing the question
                const questionItem = this.closest('li');
                
                // Remove the <li> element from the DOM
                questionItem.remove();
                
                // Optionally, remove the question's ID from the hidden input field (if needed)
                const selectedQuestionsInput = document.querySelector('input[name="selected_questions[]"][value="' + questionId + '"]');
                if (selectedQuestionsInput) {
                    selectedQuestionsInput.remove();
                }
                
                // Recalculate the numbers for the remaining questions
                const questionsList = document.querySelectorAll('#selected-questions .list-group-item');
                questionsList.forEach((item, index) => {
                    // Update the question number text
                    const questionNumber = item.querySelector('.question-number');
                    if (questionNumber) {
                        questionNumber.textContent = index + 1;
                    }
                });
            });
        });

        const questionMap = new Map(); 

        const quizDropdowns = document.querySelectorAll('.quiz-dropdown');
        quizDropdowns.forEach(dropdown => {
            dropdown.addEventListener('click', function (event) {
                // Check if the click target is NOT the `+` button or `Add All` text
                if (!event.target.classList.contains('btn-add-question') && !event.target.classList.contains('add-all-text')) {
                    const quizId = dropdown.getAttribute('id').replace('quizDropdown', 'collapse');
                    const targetCollapse = document.getElementById(quizId);

                    // Toggle the collapse state
                    const isCollapsed = targetCollapse.classList.contains('show');
                    if (isCollapsed) {
                        targetCollapse.classList.remove('show');
                    } else {
                        targetCollapse.classList.add('show');
                    }
                }
            });

            // Optional: Add functionality to the Add All button
            const addAllButton = dropdown.querySelector('.btn-add-question');
            addAllButton.addEventListener('click', function(event) {
                event.stopPropagation(); // Prevent the click from bubbling up to the dropdown
                const quizId = addAllButton.getAttribute('data-quiz-id');
                const questionId = addAllButton.getAttribute('data-question-id');
            });
        });
        

        addQuestionButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.preventDefault();
                event.stopPropagation();
                
                const questionId = this.dataset.questionId;
                const questionTextElement = this.parentElement.querySelector('.question-text');
                questionTextElement.classList.add('fw-normal');
                // CHANGE: Use innerHTML to preserve HTML structure, including images
                const questionText = questionTextElement.innerHTML; 
                const answerOptions = Array.from(this.parentElement.querySelectorAll('.answer-option'));
        
                // Kiểm tra nếu câu hỏi đã có trong danh sách
                if (questionMap.has(questionId)) {
                    const listItem = questionMap.get(questionId);
                    listItem.querySelector('.question-input').innerHTML = questionText;
        
                    // Cập nhật câu trả lời
                    const answerInputs = listItem.querySelectorAll('.answer-field');
                    answerOptions.forEach((option, index) => {
                        if (answerInputs[index]) {
                            const textarea = answerInputs[index].querySelector('textarea');
                            const checkbox = answerInputs[index].querySelector('input[type="checkbox"]');
                            textarea.value = option.innerText; 
                            checkbox.checked = option.dataset.isCorrect === "true"; // Cập nhật trạng thái checkbox
                        } else {
                            // Tạo mới nếu không tồn tại
                            addAnswerField(listItem, {
                                option_text: option.innerText,
                                is_correct: option.dataset.isCorrect === "true",
                                id: option.dataset.answerId
                            });
                        }
                    });
        
                    // Xóa bất kỳ câu trả lời nào thừa
                    answerInputs.forEach((input, index) => {
                        if (index >= answerOptions.length) {
                            input.remove(); // Xóa các câu trả lời thừa
                        }
                    });
        
                } else {
                    // Tạo mục mới cho câu hỏi đã chọn
                    const listItem = document.createElement('li');
                    // Add a data attribute to store the question's order
                    listItem.dataset.order = selectedQuestionsList.children.length + 1; 

                    listItem.className = 'list-group-item d-flex align-items-center justify-content-between'; 

                    listItem.innerHTML = `
                        <div class="question-content flex-grow-1">
                            <!-- Toolbar -->
                            <div class="btn-toolbar mb-2" role="toolbar" aria-label="Toolbar for text formatting">
                                <div class="btn-group me-2" role="group">
                                    <select class="form-control form-select-sm" style="width: auto;">
                                        <option>Normal</option>
                                        <option>Heading 1</option>
                                        <option>Heading 2</option>
                                    </select>
                                </div>
                                <div class="btn-group me-2" role="group" aria-label="Text formatting">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('bold')" title="Bold">
                                        <b>B</b>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('italic')" title="Italic">
                                        <i>I</i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('underline')" title="Underline">
                                        <u>U</u>
                                    </button>
                                    
                                </div>
                                <div class="btn-group me-2" role="group" aria-label="Lists">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('insertUnorderedList')" title="Unordered List">
                                        <i class="fas fa-list-ul"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="formatText('insertOrderedList')" title="Ordered List">
                                        <i class="fas fa-list-ol"></i>
                                    </button>
                                </div>
                                <div class="btn-group me-2" role="group" aria-label="Insert">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertImage()" title="Insert Image">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertLink()" title="Insert Link">
                                        <i class="fas fa-link"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="insertCode()" title="Insert Code">
                                        <i class="fas fa-code"></i>
                                    </button>
                                </div>
                            </div>
                            <!-- Nội dung câu hỏi -->
                            <div class="question-input" contenteditable="true" placeholder="Edit question..." 
                                    required style="min-height: 80px; 
                                    border: 1px solid #ccc; 
                                    border-radius: 10px; padding: 8px; 
                                    font-size: 16px; line-height: 1.6; 
                                    background: #fff; color: #333; 
                                    font-family: Arial, sans-serif; 
                                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
                                    outline: none; word-wrap: break-word;">
                                ${questionText} 
                            </div>
                            <div id="answerOptionsContainer" class="mt-2"></div>
                            <button class="btn btn-primary btn-sm add-answer">Add Answer</button>
                        </div>
                        <div class="actions d-flex flex-column align-items-center" style="margin-left: 10px; gap: 5px;"> <!-- Giảm khoảng cách giữa các phần tử -->
                            <i class="fas fa-trash-alt remove-question text-danger" data-question-id="${questionId}" title="Remove question" style="cursor: pointer; font-size: 1.1rem;"></i>

                            <button class="move-up btn btn-light btn-sm d-flex justify-content-center align-items-center rounded-circle" style="width: 30px; height: 30px; font-size: 0.9rem;">
                                <i class="fas fa-arrow-up" style="font-size: 0.8rem;"></i>
                            </button>

                            <span class="question-number d-flex justify-content-center align-items-center" style="font-size: 0.9rem; width: 30px; height: 30px; border-radius: 50%; background-color: #f8f9fa; color: #6c757d; font-weight: bold;"> <!-- Thêm font-weight: bold -->
                                ${listItem.dataset.order}
                            </span>

                            <button class="move-down btn btn-light btn-sm d-flex justify-content-center align-items-center rounded-circle" style="width: 30px; height: 30px; font-size: 0.9rem;">
                                <i class="fas fa-arrow-down" style="font-size: 0.8rem;"></i>
                            </button>
                        </div>
                    `;

                    // Create and append the hidden input
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'selected_questions[]';  // The [] is important!
                    hiddenInput.value = questionId;       // Use questionId (already defined in your code)
                    listItem.appendChild(hiddenInput);

                    selectedQuestionsList.appendChild(listItem);
                    questionMap.set(questionId, listItem);

                    // Function to toggle text formatting (bold, italic, etc.)
                    function toggleTextFormat(command) {
                        const selection = window.getSelection();
                        const range = selection.rangeCount > 0 ? selection.getRangeAt(0) : null;
                        if (!range) return; // If no selection exists, do nothing

                        // Check the current selection's state to determine if it's already formatted
                        const isFormatted = document.queryCommandState(command);

                        // If formatted, remove the format, else apply it
                        if (isFormatted) {
                            document.execCommand(command, false, null); // Remove the format
                        } else {
                            document.execCommand(command, false, null); // Apply the format
                        }
                    }

                    listItem.querySelector('.btn-toolbar').addEventListener('click', (event) => {
                        const button = event.target.closest('button');
                        if (!button) return; // Ignore clicks that are not on buttons
                        
                        const title = button.title;
                        console.log(`Button clicked: ${title}`);
                    
                        switch (title) {
                            case 'Bold':
                                toggleTextFormat('bold');
                                break;
                            case 'Italic':
                                toggleTextFormat('italic');
                                break;
                            case 'Underline':
                                toggleTextFormat('underline');
                                break;
                            
                            case 'Unordered List':
                                toggleTextFormat('insertUnorderedList');
                                break;
                            case 'Ordered List':
                                toggleTextFormat('insertOrderedList');
                                break;
                            case 'Insert Image':
                                const questionInput = event.currentTarget.closest('li').querySelector('.question-input'); // Get the correct questionInput
                                insertImage(questionInput); // Pass it to the function
                                break;
                            case 'Insert Link':
                                insertLink();
                                break;
                            case 'Insert Code':
                                insertCode();
                                break;
                        }
                    });
                    function insertImage(questionInput) {
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        fileInput.style.display = 'none';
                        document.body.appendChild(fileInput);
                        fileInput.click();
                    
                        fileInput.addEventListener('change', function(e) {
                            const file = e.target.files[0];
                            const reader = new FileReader();
                    
                            reader.onload = function(event) {
                                const imgSrc = event.target.result;
                                const imgContainer = document.createElement('div');
                                
                                // Căn giữa hình ảnh
                                imgContainer.style.display = 'flex';
                                imgContainer.style.justifyContent = 'center';
                                imgContainer.style.marginTop = '10px'; // Khoảng cách giữa câu hỏi và ảnh
                    
                                const imgElement = document.createElement('img');
                                imgElement.src = imgSrc;
                                imgElement.alt = file.name;
                                imgElement.style.maxWidth = '200px';
                                imgElement.style.maxHeight = '150px';
                    
                                imgContainer.appendChild(imgElement);
                    
                                // Thêm ảnh dưới câu hỏi
                                questionInput.appendChild(imgContainer);
                    
                                // Xoá file input để tránh lặp thừa
                                fileInput.remove();
                            };
                            reader.readAsDataURL(file);
                        });
                    }

                    // NOW add the event listeners:
                    const moveUpButton = listItem.querySelector('.move-up');
                    const moveDownButton = listItem.querySelector('.move-down');
                    moveUpButton.addEventListener('click', () => moveQuestion(listItem, 'up'));
                    moveDownButton.addEventListener('click', () => moveQuestion(listItem, 'down'));
        
                    // Hiển thị nút lưu nếu có ít nhất một câu hỏi
                    saveButton.style.display = 'block';
        
                    let deleted_ids = []; // Array to keep track of deleted question IDs

                    // Add event listener for removing the question
                    const removeButton = listItem.querySelector('.remove-question');
                    removeButton.addEventListener('click', () => {
                        const questionId = questionMap.get(listItem.dataset.questionId); // Get the ID of the question being removed

                        // Mark the question as deleted by adding a class
                        listItem.classList.add('deleted'); // Add a deleted class to the item
                        deleted_ids.push(questionId); // Add the question ID to the deleted_ids array

                        listItem.remove(); // Remove the question from the DOM
                        questionMap.delete(questionId); // Remove from questionMap
                        updateQuestionNumbers(); // Update numbering after deletion
                    });
                
            
        
                    // Sự kiện để thêm câu trả lời
                    const addAnswerButton = listItem.querySelector('.add-answer');
                    addAnswerButton.addEventListener('click', function () {
                        addNewAnswerField(listItem);
                    });
        
                    // Thêm các tùy chọn câu trả lời cho câu hỏi mới
                    answerOptions.forEach(option => {
                        addAnswerField(listItem, {
                            option_text: option.innerText,
                            is_correct: option.dataset.isCorrect === "true",
                            id: option.dataset.answerId
                        });
                    });
                    updateQuestionNumbers();
                }
            updateQuestionNumbers();
            });
        });
        
        function moveQuestion(listItem, direction) {
            const parent = listItem.parentNode;
            const currentIndex = Array.from(parent.children).indexOf(listItem);
        
            if (direction === 'up' && currentIndex > 0) {
                parent.insertBefore(listItem, parent.children[currentIndex - 1]);
            } else if (direction === 'down' && currentIndex < parent.children.length - 1) {
                parent.insertBefore(listItem, parent.children[currentIndex + 1 === parent.children.length ? currentIndex + 1 : parent.children[currentIndex + 2] ]); // Corrected this logic
        
            }
        
            updateQuestionNumbers();
        }
        
        
        function updateQuestionNumbers() {
            const questions = selectedQuestionsList.querySelectorAll('li');
            questions.forEach((question, index) => {
                question.dataset.order = index + 1;
                const numberSpan = question.querySelector('.question-number');
                if (numberSpan) {
                        numberSpan.textContent = index + 1;
                }
                
            });
        }

        // Function to dynamically add answer fields for editing
        function addAnswerField(listItem, answerData = null) {
            const newAnswerDiv = document.createElement('div');
            newAnswerDiv.className = 'form-group mb-3 answer-field';
            console.log(listItem)
            // Sử dụng dữ liệu câu trả lời nếu có
            let answerText = answerData ? answerData.option_text : ""; // Nội dung câu trả lời
            let isChecked = answerData && (answerData.is_correct === 'true' || answerData.is_correct === true) ? "checked" : ""; // Trạng thái checkbox
            let answerId = answerData ? answerData.id : ""; // ID câu trả lời
        
            newAnswerDiv.innerHTML = `
                <div class="input-group">
                    <input type="checkbox" class="form-check-input" name="is_correct[]" value="${answerId}" ${isChecked}>
                    <input type="hidden" name="answer_id[]" value="${answerId}">
                    
                    <textarea class="form-control" style="${answerData && (answerData.is_correct === 'true' || answerData.is_correct === true) ? 'background-color: #d9f7d9;' : ''}"
                            name="option_text[]" 
                            placeholder="Enter answer..." 
                            required>${answerText}</textarea>
                    
                    <i class="fas fa-times remove-answer" data-answer-id="${answerId}" style="color: #dc3545; cursor: pointer;"></i>
                </div>
            `;
            

            listItem.querySelector('#answerOptionsContainer').appendChild(newAnswerDiv);
        
            // Thêm chức năng xóa cho câu trả lời
            const removeButton = newAnswerDiv.querySelector('.remove-answer');
            removeButton.addEventListener('click', () => {
                newAnswerDiv.remove(); // Xóa câu trả lời khỏi DOM
            });
        }
        
        

        function addNewAnswerField(listItem) {
            addAnswerField(listItem); // Call to add a new empty answer field
        }

        saveButton.addEventListener('click', function () {
            const savedData = [];
        
            // Collect edited questions and answers
            questionMap.forEach((item, questionId) => {
                const editedQuestionText = item.querySelector('.question-input').innerHTML;
                const answerInputs = Array.from(item.querySelectorAll('.answer-field'));
                
                // Check if the question is marked as deleted
                if (item.classList.contains('deleted')) {
                    deletedIds.push(questionId); // Collect ID of deleted question
                    return; // Skip this question
                }

                const editedAnswerOptions = answerInputs.map(input => {
                    const textarea = input.querySelector('textarea');
                    const checkbox = input.querySelector('input[type="checkbox"]');
                    return {
                        text: textarea.value,
                        is_correct: checkbox.checked 
                    };
                });
        
                // Save edited question information
                if (editedQuestionText !== '' || editedAnswerOptions.some(option => option.text !== '')) {
                    savedData.push({
                        id: questionId, // Existing question ID if updating
                        text: editedQuestionText,
                        answers: editedAnswerOptions.map(answer => ({ text: answer.text, is_correct: answer.is_correct })) 
                    });
                }
            });
        
            // Collect new questions that need to be added
            const newQuestions = document.querySelectorAll('.new-question'); // Class for new questions in HTML
        
            newQuestions.forEach((newItem) => {
                const newQuestionText = newItem.querySelector('.question-input').value;
                const newAnswerInputs = Array.from(newItem.querySelectorAll('.answer-field'));
        
                const newAnswerOptions = newAnswerInputs.map(input => {
                    const textarea = input.querySelector('textarea');
                    const checkbox = input.querySelector('input[type="checkbox"]');
                    return {
                        text: textarea.value,
                        is_correct: checkbox.checked 
                    };
                });
        
                // Only add new question if it is not empty
                if (newQuestionText !== '' || newAnswerOptions.some(option => option.text !== '')) {
                    savedData.push({
                        text: newQuestionText,
                        answers: newAnswerOptions.map(answer => ({ text: answer.text, is_correct: answer.is_correct })) 
                    });
                }
            });
        
            // Collect copied questions from another quiz (if applicable)
            const copiedQuestionElements = document.querySelectorAll('.copied-question'); // Class for copied questions
            copiedQuestionElements.forEach((item) => {
                const copiedQuestionId = item.dataset.questionId; // Assuming question ID is stored in a data attribute
                const copiedQuestionText = item.querySelector('.copied-question-text').innerText.trim();
                const answerOptions = Array.from(item.querySelectorAll('.copied-answer-option')); // Class for copied answer options
        
                const copiedAnswerOptions = answerOptions.map(option => {
                    return {
                        text: option.querySelector('.copied-answer-text').value,
                        is_correct: option.querySelector('.copied-answer-checkbox').checked 
                    };
                });
        
                // Add copied question and answers to saved data
                if (copiedQuestionText !== '' || copiedAnswerOptions.some(option => option.text !== '')) {
                    savedData.push({
                        text: copiedQuestionText,
                        answers: copiedAnswerOptions.map(answer => ({ text: answer.text, is_correct: answer.is_correct })) 
                    });
                }
            });

        
            // Determine the URL based on the presence of assessment.id
            const url = "{% if assessment and assessment.id %}{% url 'assessment:assessment_edit' assessment.id %}{% else %}{% url 'assessment:assessment_create' %}{% endif %}";

            // Send collected data
            if (savedData.length > 0 || deletedIds.length > 0) {
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'), 
                    },
                    body: JSON.stringify({
                        questions: savedData,
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    if (data.status === 'success') {
                        location.reload(); // Reload the page if saved successfully
                    } else {
                        alert('Failed to save questions and answers.');
                    }
                })
                .catch(error => console.error('Error:', error));
            } else {
                alert('No changes detected to save.');
            }
        });
        
        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        

        const addQuizButtons = document.querySelectorAll('.add-questions');

        addQuizButtons.forEach(button => {
            button.addEventListener('click', function () {
                
                const questions = this.closest('.accordion-header').nextElementSibling.querySelectorAll('.add-question');
        
                // Kiểm tra nếu danh sách đã có câu hỏi
                if (selectedQuestionsList.children.length === 0) {  
                    // Nếu danh sách rỗng, thêm các câu hỏi vào danh sách
                    questions.forEach(question => {
                        question.click();
                    });
                } else {
                    // Nếu danh sách không rỗng, xóa tất cả câu hỏi khỏi danh sách
                    while (selectedQuestionsList.firstChild) {
                        selectedQuestionsList.removeChild(selectedQuestionsList.firstChild);
                    }
                    questionMap.clear(); 
                    saveButton.style.display = 'none'; 
                }
            });
        });
    });
            
        

    // Function to filter exercises in the list
    function filterExercises() {
        const input = document.getElementById('search-exercises').value.toLowerCase();
        const selectedLanguage = document.getElementById('id_language').value.toLowerCase();
        const exercises = document.querySelectorAll('.exercise-item');
        const filteredExercisesContainer = document.getElementById('filtered-exercises');
        filteredExercisesContainer.innerHTML = '';

        if (input.trim() === "" && selectedLanguage === "") {
            // Show all if both search and language filter are empty
            filteredExercisesContainer.style.display = 'none';
            document.getElementById('exercise-list').style.display = 'block';
            exercises.forEach(exercise => exercise.style.display = 'flex');
            return;
        }

        let filteredExercises = [];
        let addedExerciseIds = new Set();

        exercises.forEach(exercise => {
            const title = exercise.querySelector('label').textContent.toLowerCase();
            const exerciseLanguage = exercise.querySelector('.badge').textContent.toLowerCase();
            const exerciseId = exercise.dataset.exerciseId;

            const titleMatches = title.includes(input);
            const languageMatches = selectedLanguage === "" || exerciseLanguage === selectedLanguage;


            if (titleMatches && languageMatches && !addedExerciseIds.has(exerciseId)) {
                filteredExercises.push(exercise.cloneNode(true));
                addedExerciseIds.add(exerciseId);
            }
        });


        if (filteredExercises.length > 0) {
        // Display the filtered results
            document.getElementById('exercise-list').style.display = 'none';
            filteredExercisesContainer.style.display = 'block';
            filteredExercises.forEach(exercise => filteredExercisesContainer.appendChild(exercise));

        } else {

            if(input !== "" && selectedLanguage !== "")
            {
            document.getElementById('exercise-list').style.display = 'block';
            filteredExercisesContainer.style.display = 'none';

            exercises.forEach(exercise => {
                    const title = exercise.querySelector('label').textContent.toLowerCase();
                    const languageBadge = exercise.querySelector('.badge');
                    const exerciseLanguage = languageBadge ? languageBadge.textContent.toLowerCase() : '';
                    if (title.includes(input) && exerciseLanguage.includes(selectedLanguage) ) {
                        exercise.style.display = 'flex';
                    } else {
                        exercise.style.display = 'none';
                    }
                });
            }
            else if (selectedLanguage !== "") {
            document.getElementById('exercise-list').style.display = 'block';
            filteredExercisesContainer.style.display = 'none';
                exercises.forEach(exercise => {
                    const languageBadge = exercise.querySelector('.badge');
                    const exerciseLanguage = languageBadge ? languageBadge.textContent.toLowerCase() : ''; // Get the language. Handle cases where the badge might not exist.

                    if (exerciseLanguage === selectedLanguage) {
                        exercise.style.display = 'flex';
                    } else {
                        exercise.style.display = 'none';
                    }
                });
            }
            else {

                filteredExercisesContainer.style.display = 'none';
                document.getElementById('exercise-list').style.display = 'block';
                exercises.forEach(exercise => {
                    const title = exercise.querySelector('label').textContent.toLowerCase();
                    if (title.includes(input)) {
                        exercise.style.display = 'flex';
                    } else {
                        exercise.style.display = 'none';
                    }
                });
            }

        }
    }


    document.getElementById('id_language').addEventListener('change', filterExercises);
    document.getElementById('search-exercises').addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            filterExercises();
        }
    });

    function filterQuestions() {
        const input = document.getElementById('search-questions').value.toLowerCase();
        const quizAccordion = document.getElementById('quizAccordion');
        const accordionItems = quizAccordion.querySelectorAll('.accordion-item');
    
        accordionItems.forEach(item => {
            const questionsList = item.querySelector('.list-group');
            const accordionCollapse = item.querySelector('.accordion-collapse');
            let anyMatchInQuiz = false;
    
            if (questionsList) {
                const questions = questionsList.querySelectorAll('.list-group-item');
    
                // Hide all questions initially
                questions.forEach(question => {
                    question.style.display = 'none';
                });
    
                // Loop through each question to check if it matches the search term
                questions.forEach(question => {
                    const questionText = question.querySelector('.question-text').textContent.toLowerCase();
                    const isMatch = questionText.includes(input);
    
                    if (isMatch) {
                        question.style.display = 'block'; // Show only the matching question
                        anyMatchInQuiz = true;
                    }
                });
    
                // Show only quizzes that contain a matching question
                const quizHeader = item.querySelector('.quiz-dropdown');
                if (input === "") {
                    // Show all quizzes and questions if input is empty
                    item.style.display = 'block';
                    quizHeader.style.display = 'block';
                    accordionCollapse.classList.remove('show'); // Collapse quiz if input is empty
                    questions.forEach(question => {
                        question.style.display = 'block'; // Show all questions
                    });
                } else {
                    // Show only quizzes with at least one matching question
                    item.style.display = anyMatchInQuiz ? 'block' : 'none';
                    quizHeader.style.display = anyMatchInQuiz ? 'block' : 'none';
                    accordionCollapse.classList.toggle('show', anyMatchInQuiz); // Expand quiz only if it has a matching question
                }
            }
        });
    }
        
    

    fullscreenPreview.appendChild(closeFullscreenButton);

    function viewExercise(exerciseId) {
        const exerciseContent = document.getElementById('exercise-content');
        const fullscreenPreview = document.getElementById('fullscreen-preview');
        
        // Use a data attribute to track the currently displayed exercise ID
        const displayedExerciseId = exerciseContent.dataset.exerciseId;

        if (displayedExerciseId == exerciseId) {
            exerciseContent.innerHTML = '<p>Select an exercise from the list to preview its content here.</p>';
            delete exerciseContent.dataset.exerciseId; // Clear the data attribute
            return;
        }

        fetch("{% url 'assessment:get_exercise_content' 0 %}".replace('0', exerciseId))
            .then(response => {
                if (!response.ok) {
                    console.error("Fetch error:", response.status, response.statusText); 
                    exerciseContent.innerHTML = `<p>Error loading exercise ${exerciseId}: ${response.status} ${response.statusText}</p>`;
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                exerciseContent.innerHTML = `
                    <div class="d-flex align-items-start">
                        <h3 style="font-size: 1.2rem; margin-bottom: 0;">Exercise ${exerciseId}: ${data.title}</h3>
                        <span id="extend-button" class="ms-auto" style="display: inline-block; transform: rotate(135deg);">↔</span>
                    </div>
                    <p>${data.content}</p>
                    `;
                
                exerciseContent.dataset.exerciseId = exerciseId; // Set the data attribute
                const extendButton = document.getElementById('extend-button');

                extendButton.addEventListener('click', (event) => {
                    event.preventDefault(); 

                    fullscreenPreview.innerHTML = `
                        <div class="d-flex justify-content-center align-items-center w-100 h-100 bg-light" style="opacity: 0.8;">
                        <div class="fullscreen-preview-content p-4 bg-white" style="border-radius: 5px; position: relative; max-width: 80%; max-height: 80%; overflow-y: auto;">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 style="margin-bottom: 0; font-size: 1.2rem;">Exercise ${exerciseId}: ${data.title}</h3> <!-- Điều chỉnh kích thước ở đây -->
                                <span id="close-fullscreen" aria-label="Close" style="cursor: pointer; font-size: 1.5rem;">×</span>
                            </div>
                            <p>${data.content}</p>
                        </div>
                    </div>
                    `;

                    fullscreenPreview.classList.remove('d-none');

                    const closeBtn = document.getElementById('close-fullscreen');
                    closeBtn.addEventListener('click', (event) => {
                        event.stopPropagation();
                        fullscreenPreview.classList.add('d-none');
                    });

                    fullscreenPreview.addEventListener('click', (event) => {
                        if (event.target === fullscreenPreview) {
                            fullscreenPreview.classList.add('d-none');
                        }
                    });

                    fullscreenPreview.classList.remove('d-none');
                });
            })
            .catch(error => {
                console.error('Error fetching exercise content:', error);
                exerciseContent.innerHTML = `<p>Error loading exercise ${exerciseId}. See console for details.</p>`;
                delete exerciseContent.dataset.exerciseId; // Clear in case of error
            });
    }


    // Hàm để chuyển đổi trạng thái nút và gọi viewExercise
    function toggleViewButton(button, exerciseId) {
            const icon = button.querySelector('i');
            const isActive = button.classList.contains("active");

            if (isActive) {
                // Nếu đã active, thì reset về trạng thái ban đầu
                button.classList.remove("active", "text-primary");
                button.classList.add("text-secondary");
                icon.classList.remove("bi-eye");
                icon.classList.add("bi-eye-slash");
                viewExercise(null); // Đóng nội dung
            } else {
                // Nếu chưa active, thì hiển thị nội dung
                button.classList.add("active", "text-primary");
                button.classList.remove("text-secondary");
                icon.classList.remove("bi-eye-slash");
                icon.classList.add("bi-eye");
                viewExercise(exerciseId); // Hiển thị nội dung
            }
        }
    // Add active class to exercise-item (No changes needed here)
    const exerciseItems = document.querySelectorAll('.exercise-item');
    exerciseItems.forEach(item => {
        item.addEventListener('click', function(event) {
            if (event.target.tagName !== 'BUTTON' ) {
                exerciseItems.forEach(otherItem => otherItem.classList.remove('selected'));
                this.classList.add('selected');
            }
        });
    });



</script>
{% endblock %}
