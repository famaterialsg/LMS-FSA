{% extends "base_generic.html" %}

{% block left_content %}

{% if messages %}
    <div id="message-container">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    </div>
{% endif %}
<style>
    /* Define specific widths for each column */
    .table th:nth-child(1), .table td:nth-child(1) { width: 1%; } /* First column */
    .table th:nth-child(2), .table td:nth-child(2) { width: 25%; } /* Second column */
    .table th:nth-child(3), .table td:nth-child(3) { width: 5%; } /* Third column */
    .table th:nth-child(4), .table td:nth-child(4) { width: 5%; } /* Fourth column */
    .table th:nth-child(5), .table td:nth-child(5) { width: 54%; } /* Fifth column */
    .table th:nth-child(6), .table td:nth-child(6) { width: 10%; } /* Sixth column */
    /* Default to 80vh */
    .custom-max-height {
        max-height: 75vh;
    }

    /* Apply 50vh for screens with a max height of around 14 inches (typically 900px in height or below) */
    @media (max-height: 900px) {
        .custom-max-height {
            max-height: 72vh;
        }
    }
    .table {
        font-family: arial, sans-serif;
        border-collapse: collapse;
        width: 100%;
    }
    .table th, td {
        border: 1px solid #dddddd;
        text-align: left;
        padding: 8px;
        background-color: #96D4D4;
    }
    .table thead {
        position: sticky; 
        top: 0; 
        z-index: 1020; 
        background: white;
    }
    
</style>
<div class="container-fluid h-100">
    <div class="row h-100">
        <div class="col-12">
            <h2>Programming Exercises</h2>

            <div class="d-flex mb-3">
                <!-- Dropdown to filter exercises by language -->
                <form method="get" class="d-flex align-items-center" style="width: 30%;">
                    <label for="language" class="form-label me-2" style="width: 31%;">Filter by Language:</label>
                    <select name="language" id="language" class="form-select me-2" style="width: 40%;">
                        <option value="">All Languages</option>
                        {% for language in languages %}
                            <option value="{{ language }}" {% if language == selected_language %}selected{% endif %}>
                                {{ language | capfirst }}
                            </option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-secondary">Filter</button>
                </form>

                <div class="ms-auto d-flex align-items-center justify-content-end gap-2">
                    <a href="{% url 'exercises:exercise_add' %}" class="btn btn-primary" title="Add New Exercise" data-bs-toggle="tooltip">
                        <i class="fas fa-plus"></i> Add a new exercise
                    </a>
                    <form method="post" action="{% url 'exercises:delete_exercises_bulk' %}" id="bulk-delete-form">
                        {% csrf_token %}
                        <div id="selected-ids-container"></div>
                        <button type="submit" class="btn btn-danger" title="Delete selected exercises">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </form>
                    <a href="{% url 'assessment:assessment_list' %}" class="btn btn-secondary">
                        <i class="fa-solid fa-backward"></i> Back to Assessments
                    </a>
                </div>
            </div>

            <!-- List of exercises -->
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="select-all">
                        </th>
                        <th>Title</th>
                        <th>Language</th>
                        <th>Level</th>
                        <th>Description</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exercise in exercises %}
                    <tr>
                        <td>
                            <input type="checkbox" class="select-row" data-id="{{ exercise.id }}">
                        </td>
                        <td>{{ exercise.title }}</td>
                        <td>{{ exercise.language | capfirst }}</td>
                        <td>
                            {% if exercise.level == 'easy' %}
                            <span class="badge text-success">
                                {{ exercise.level | capfirst }}</span>
                            {% elif exercise.level == 'medium' %}
                            <span class="badge text-warning">
                                {{ exercise.level | capfirst }}</span>
                            {% else %}
                            <span class="badge text-danger">
                                {{ exercise.level | capfirst }}</span>
                            {% endif %}
                        </td>
                        <td>{{ exercise.description| truncatewords:8 | safe}}</td>
                        <td>
                            <div class="d-flex gap-1">
                                {% if assessment_id %}
                                <form action="{% url 'exercises:exercise_detail' exercise.id assessment_id %}" method="get">
                                    <button type="submit" class="btn btn-outline-primary btn-sm"><i class="fas fa-info-circle"></i></button>
                                </form>
                                {% else %}
                                <form action="{% url 'exercises:exercise_detail_no_attempt' exercise.id %}" method="get">
                                    <button type="submit" class="btn btn-outline-primary btn-sm"><i class="fas fa-info-circle"></i></button>
                                </form>
                                {% endif %}
                                <form method="post" action="{% url 'exercises:delete_exercise' exercise.id %}" onsubmit="return confirm('Are you sure you want to delete this exercise?');">
                                    {% csrf_token %}
                                    <button class="btn btn-outline-danger btn-sm"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5">No exercises are available.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Bootstrap Pagination -->
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mt-4">
                    {% if exercises.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&language={{ selected_language }}" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ exercises.previous_page_number }}&language={{ selected_language }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% endif %}

                    <!-- Show page numbers -->
                    {% for num in exercises.paginator.page_range %}
                        {% if exercises.number == num %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > exercises.number|add:-3 and num < exercises.number|add:3 %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}&language={{ selected_language }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if exercises.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ exercises.next_page_number }}&language={{ selected_language }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ exercises.paginator.num_pages }}&language={{ selected_language }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
<script>
    document.getElementById('select-all').addEventListener('change', function () {
        var checkboxes = document.querySelectorAll('.select-row');
        for (var checkbox of checkboxes) {
            checkbox.checked = this.checked;
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const bulkDeleteForm = document.querySelector('#bulk-delete-form');

        if (bulkDeleteForm) {
            bulkDeleteForm.addEventListener('submit', function (e) {
                const selectedIds = [];
                const checkboxes = document.querySelectorAll('.select-row:checked');

                for (const checkbox of checkboxes) {
                    const id = checkbox.getAttribute('data-id');
                    if (id) selectedIds.push(id);
                }

                if (selectedIds.length === 0) {
                    e.preventDefault();
                    alert('No exercises selected.');
                } else {
                    if (confirm('Are you sure you want to delete the selected exercises?')) {
                        const idsContainer = document.getElementById('selected-ids-container') || document.createElement('div');
                        idsContainer.id = 'selected-ids-container';
                        idsContainer.innerHTML = '';

                        selectedIds.forEach(id => {
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'ids';
                            input.value = id;
                            idsContainer.appendChild(input);
                        });

                        this.appendChild(idsContainer);
                    }
                }
            });
        }
    });


    document.addEventListener("DOMContentLoaded", function() {
        // Set timer to hide message
        const messageContainer = document.getElementById('message-container');
        if (messageContainer) {
            setTimeout(function() {
                messageContainer.style.display = 'none';
            }, 3000); 
        }
    });

</script>
{% endblock %}
