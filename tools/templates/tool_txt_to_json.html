{% extends 'base.html' %}

{% block content %}
<div class="mt-1">
    {% include "menuTools.html" %}
    
    <h2 class="mb-4 text-center">Convert TXT to JSON</h2>

    <!-- Form for specifying number of TXT files -->
    <div class="row justify-content-center" id="file-number-form-container" {% if success_message %}style="display: none;"{% endif %}>
        <div class="col-md-8">
            <form id="file-number-form" class="border p-4 rounded shadow-sm bg-light">
                {% csrf_token %}
                <div class="form-group">
                    {{ form.number_of_files.label_tag }}
                    {{ form.number_of_files }}
                </div>
                <button type="button" id="generate-textareas" class="btn btn-primary mt-3">Generate</button>
            </form>
        </div>
    </div>

    <!-- Form for pasting TXT file contents, initially hidden -->
    <div id="textareas-container" class="mt-4" style="display: none;">
        <button type="button" id="back-button" class="btn btn-secondary mt-3">Back to Number TXT</button>
        <form method="POST" action="{% url 'tools:txt_to_json_view' %}" class="border p-4 rounded shadow-sm bg-light" id="text-to-json-form">
            {% csrf_token %}
            <input type="hidden" name="number_of_files" id="hidden-number-of-files" value="">
            <div id="textareas-wrapper"></div>
            <button type="submit" class="btn btn-success btn-block mt-4">Convert to JSON</button>
        </form>
    </div>
    
    <!-- Display the success message and list of files if JSON files are generated -->
    {% if success_message %}
        <div class="mt-4">
            <h3 class="text-success">Success!</h3>
            <p>{{ success_message }}</p>
            <p>Files created:</p>
            <ul class="list-group">
                {% for file_name, file_url, num_questions in file_names_and_urls %}
                    <li class="list-group-item d-flex align-items-center justify-content-between">
                        <!-- Cột chứa tên file và số câu hỏi -->
                        <div class="d-flex flex-column col-md-8">
                            <span class="font-weight-bold">{{ file_name }}</span>
                            <small class="text-muted">Number of Questions: {{ num_questions }}</small>
                        </div>
                        <!-- Cột chứa nút download -->
                        <div class="col-md-4 text-right">
                            <a href="{{ file_url }}" class="btn btn-outline-primary btn-sm">Download</a>
                        </div>
                    </li>
                {% endfor %}
            </ul>
            <div class="mt-3">
                <a href="{{ download_url }}" class="btn btn-primary mr-2">Download All as ZIP</a>
                <a href="{% url 'tools:txt_to_json_view' %}" class="btn btn-secondary">Refresh</a>
            </div>
        </div>

    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const inputField = document.querySelector('[name="number_of_files"]');  // Get the input field for number of files
        const generateButton = document.getElementById('generate-textareas');  // Get the "Generate" button
        const textareasContainer = document.getElementById('textareas-container');  // Get the container for textareas
        const submitFormContainer = document.getElementById('submit-form-container');  // Get the submit form container
        const fileNumberFormContainer = document.getElementById('file-number-form-container');  // Get the container for number of files form
        const textareasWrapper = document.getElementById('textareas-wrapper');  // Get the wrapper for the textareas
        const hiddenNumberOfFilesInput = document.getElementById('hidden-number-of-files');  // Get the hidden input for number of files
        const form = document.getElementById('text-to-json-form');  // Get the form element for submission
        const backButton = document.getElementById('back-button');
        backButton.addEventListener('click', function() {
        // Show the number of files form
        fileNumberFormContainer.style.display = 'flex';

        // Hide the textareas container
        textareasContainer.style.display = 'none';
        });
        // Set default value to 1 if the field is empty or invalid (less than 1)
        if (!inputField.value || inputField.value < 1) {
            inputField.value = 1;  // Ensure the minimum value is 1
        }

        // Prevent form submission when Enter key is pressed
        inputField.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();  // Prevent form submission when Enter is pressed
                if (validateInput()) {
                    generateTextareas();  // Trigger function to generate textareas if input is valid
                }
            }
        });

        // Add event listener for the "Generate" button
        generateButton.addEventListener('click', function(event) {
            if (validateInput()) {  // Only generate textareas if input is valid
                generateTextareas();
            }
        });

        // Validate input on blur (when the user moves away from the field)
        inputField.addEventListener('blur', validateInput);

        // Function to validate the input value
        function validateInput() {
            const numFiles = parseInt(inputField.value, 10);

            // Check if the number is less than 1
            if (isNaN(numFiles) || numFiles < 1) {
                alert("Please enter a number greater than or equal to 1.");  // Show an error message
                inputField.value = 1;  // Reset to minimum value of 1
                inputField.focus();  // Focus back to the input field
                return false;  // Return false if validation fails
            }
            return true;  // Return true if validation passes
        }

        // Function to generate textareas based on number of files
        function generateTextareas() {
            const numFiles = parseInt(inputField.value, 10);  // Parse the number of files entered

            // Clear any existing textareas if present
            textareasWrapper.innerHTML = '';

            // Store the number of files in the hidden input field
            hiddenNumberOfFilesInput.value = numFiles;

            // Create textareas for each file
            for (let i = 0; i < numFiles; i++) {
                const textarea = document.createElement('textarea');
                textarea.name = 'txt_file_' + i;
                textarea.rows = 5;
                textarea.className = 'form-control mb-2';
                textarea.placeholder = 'Content for TXT file ' + (i + 1);
                textareasWrapper.appendChild(textarea);
            }

            // Hide the number of files form
            fileNumberFormContainer.style.display = 'none';

            // Show the textareas container and submit button
            textareasContainer.style.display = 'block';
            submitFormContainer.style.display = 'block';
        }

        // Prevent form submission if textareas are empty
        form.addEventListener('submit', function(event) {
            const textareas = textareasWrapper.querySelectorAll('textarea');
            let isAnyTextareaFilled = false;

            // Check if at least one textarea has content
            textareas.forEach(textarea => {
                if (textarea.value.trim() !== '') {
                    isAnyTextareaFilled = true;
                }
            });

            // If all textareas are empty, prevent form submission and show an alert
            if (!isAnyTextareaFilled) {
                event.preventDefault();
                alert("Please enter data in at least one of the text areas.");
            }
        });
    });
</script>
{% endblock %}