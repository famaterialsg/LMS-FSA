{% extends 'base.html' %}

{% block title %}Edit Quiz{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Edit Quiz</h2>

    <form method="post" enctype="multipart/form-data" id="quizForm">
        {% csrf_token %}

        <div class="mb-3">
            <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
            {{ form.title }}
        </div>
        <div class="mb-3">
            <label for="{{ form.course.id_for_label }}" class="form-label">Course</label>
            {{ form.course }}
        </div>
        <div class="mb-3">
            <label for="{{ form.category.id_for_label }}" class="form-label">Category</label>
            {{ form.category }}
        </div>
        <div class="mb-3">
            <label for="{{ form.due_date.id_for_label }}" class="form-label">Due Date</label>
            {{ form.due_date }}
        </div>
        <div class="mb-3">
            <label for="{{ form.attempts_allowed.id_for_label }}" class="form-label">Attempts Allowed</label>
            {{ form.attempts_allowed }}
        </div>

        <div class="mb-3">
            <label for="{{ form.grading_method.id_for_label }}" class="form-label">Grading Method</label>
            {{ form.grading_method }}
        </div>

        <button type="button" class="btn btn-secondary" id="selectQuestionsBtn">Load Questions</button>

        <div id="questionSelection">
            <h3 class="mt-4">Select Questions</h3>
            <div id="questionList">
                {% for question in quiz.questions.all %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="selected_questions" value="{{ question.id }}" id="question_{{ question.id }}" checked>
                                <label class="form-check-label" for="question_{{ question.id }}">
                                    {{ question.question_text }}
                                </label>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Update Quiz</button>
        <a href="{% url 'quiz:quiz_detail' quiz.id %}" class="btn btn-secondary mt-3">Cancel</a>
    </form>
</div>

<script>
document.getElementById('selectQuestionsBtn').addEventListener('click', function() {
    var course = document.getElementById('{{ form.course.id_for_label }}').value;
    var category = document.getElementById('{{ form.category.id_for_label }}').value;

    if (course && category) {
        fetch(`{% url 'quiz:load_questions' %}?course=${course}&category=${category}`)
            .then(response => response.json())
            .then(data => {
                var questionList = document.getElementById('questionList');
                questionList.innerHTML = '';
                data.questions.forEach(question => {
                    var questionDiv = document.createElement('div');
                    questionDiv.className = 'card mb-3';
                    questionDiv.innerHTML = `
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="selected_questions" value="${question.id}" id="question_${question.id}">
                                <label class="form-check-label" for="question_${question.id}">
                                    ${question.text}
                                </label>
                            </div>
                            <div class="mt-2">
                                <strong>Answers:</strong>
                                <ul>
                                    ${question.answers.map(answer => `
                                        <li>${answer.text} ${answer.is_correct ? '(Correct)' : ''}</li>
                                    `).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                    questionList.appendChild(questionDiv);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while loading questions. Please try again.');
            });
    } else {
        alert('Please select a course and category first.');
    }
});
</script>
{% endblock %}
