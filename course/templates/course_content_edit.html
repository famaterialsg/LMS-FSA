{% extends 'base.html' %}

{% block title %}Edit Content for {{ course.course_name }}{% endblock %}

{% block content %}
<h1>Edit Content for {{ course.course_name }}</h1>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <h3>Select Session</h3>
    <select name="session_id" id="session-select" onchange="this.form.submit()">
        <option value="" disabled selected>Select a session</option>
        {% for session in sessions %}
            <option value="{{ session.id }}" {% if session.id == selected_session.id %}selected{% endif %}>{{ session.name }}</option>
        {% endfor %}
    </select>

    <!-- Hidden input to store selected session ID -->
    <input type="hidden" name="session_id_hidden" value="{{ selected_session.id }}">

    <h2>Material</h2>
    <ul>
        {% for reading_material in reading_materials %}
            <li>
                <a href="{% url 'course:reading_material_detail' reading_material.id %}" target="_blank" style="font-size: 1em;">{{ reading_material.title }}</a>
                <span style="margin-left: 10px; font-style: italic;">(Type: {{ reading_material.material.material_type }})</span>

                <a href="{% url 'course:edit_reading_material' course.pk sessions.0.id reading_material.id %}" class="btn btn-warning btn-sm" style="margin-left: 10px;">Edit</a>
                <input type="checkbox" name="delete_reading_material_{{ reading_material.id }}" style="margin-left: 10px;"> Delete
            </li>
        {% empty %}
            <li>No materials available.</li>
        {% endfor %}
    </ul>

    <h3>Add New Content</h3>

    <div id="reading-materials">
        <div class="reading-material-entry">
            <input type="text" name="reading_material_title[]" class="form-control" placeholder="Reading Material Title">
            <textarea name="reading_material_content[]" class="form-control ckeditor"></textarea>
            <select name="reading_material_type[]" class="form-control">
                <option value="" disabled selected>Select Material Type</option>
                {% for key, value in material_types.items %}
                    <option value="{{ key }}">{{ value }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-danger delete-reading-material" style="margin-left: 10px;">Delete</button>
        </div>
    </div>

    <button type="button" id="add-reading-material" class="btn btn-secondary">Add Another Reading Material</button>

    <h3>Upload PDF Content</h3>
    <div id="pdf-upload">
        <input type="file" name="uploaded_material_file[]" class="form-control" accept="application/pdf" multiple>
        <select name="uploaded_material_type[]" class="form-control">
            <option value="" disabled selected>Select Material Type</option>
            {% for key, value in material_types.items %}
                <option value="{{ key }}">{{ value }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Moved buttons below the add-reading-material button -->
    <button type="submit" class="btn btn-primary mt-3">Save</button>
    <a href="{% url 'course:course_edit' course.id %}" class="btn btn-warning btn-sm mt-3">Back to Course Edit</a>
</form>
{% load static %}
<script src="{% static 'ckeditor/ckeditor-init.js' %}"></script>
<script src="https://cdn.ckeditor.com/4.16.0/full/ckeditor.js"></script>
<script>
    let readingMaterialCounter = 1; // Start with 1 since we already have one entry

    function addRMEntry() {
        const container = document.getElementById('reading-materials');
        const newEntry = document.createElement('div');
        newEntry.className = 'reading-material-entry';
        newEntry.innerHTML = `
            <input type="text" name="reading_material_title[]" class="form-control" placeholder="Reading Material Title">
            <textarea name="reading_material_content[]" class="form-control ckeditor"></textarea>
            <select name="reading_material_type[]" class="form-control">
                <option value="" disabled selected>Select Material Type</option>
                {% for key, value in material_types.items %}
                    <option value="{{ key }}">{{ value }}</option>
                {% endfor %}
            </select>
            <button type="button" class="btn btn-danger delete-reading-material" style="margin-left: 10px;">Delete</button>
        `;
        container.appendChild(newEntry);

        // Initialize CKEditor for the newly added textarea
        const newTextarea = newEntry.querySelector('textarea');
        initializeCKEditor(newTextarea);

        attachDeleteButton(newEntry.querySelector('.delete-reading-material'));
        readingMaterialCounter++;
    }

    function initializeCKEditor(textarea) {
        CKEDITOR.replace(textarea, {
            height: 300,
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        initializeCKEditor(document.querySelector('.ckeditor'));

        document.getElementById('add-reading-material').addEventListener('click', addRMEntry);

        document.querySelectorAll('.delete-reading-material').forEach(button => {
            attachDeleteButton(button);
        });
    });

    function attachDeleteButton(button) {
        button.addEventListener('click', function() {
            const entry = this.parentNode;
            entry.parentNode.removeChild(entry);
        });
    }
</script>
{% endblock %}
