{% extends 'base.html' %}
{% load form_filters %}

{% block title %}Edit {{ course.course_name }}{% endblock %}

{% block content %}
<div class="container">
    <h1>Edit {{ course.course_name }}</h1>
    <form method="post" enctype="multipart/form-data" onsubmit="updateTagsInput()">
        {% csrf_token %}

        <input type="hidden" name="tags" id="tags-input" value="{{ course.tags|default:'' }}" /> <!-- Ensure tags are passed -->

        <div class="form-group">
            {{ course_form.course_name.label_tag }}
            {{ course_form.course_name|add_class:"form-control" }}
        </div>
        <div class="form-group">
            {{ course_form.course_code.label_tag }}
            {{ course_form.course_code|add_class:"form-control" }}
        </div>
        <div class="form-group">
            {{ course_form.description.label_tag }}
            {{ course_form.description|add_class:"form-control" }}
        </div>
        <div class="form-group">
            {{ course_form.instructor.label_tag }}
            {{ course_form.instructor|add_class:"form-control" }}
        </div>

        <!-- Select Topics -->
        <div class="form-group">
            <h3>Select Topics</h3>
            <div>
                <input type="checkbox" value="technology" onchange="updateTagsDropdown()"> Technology
                <input type="checkbox" value="business" onchange="updateTagsDropdown()"> Business
                <input type="checkbox" value="language" onchange="updateTagsDropdown()"> Language
                <input type="checkbox" value="design" onchange="updateTagsDropdown()"> Design
                <input type="checkbox" value="skills" onchange="updateTagsDropdown()"> Skills
            </div>
        </div>

        <!-- Tags Sections -->
        <div id="tags-container" class="form-group" style="display: none;">
            <div id="technology-tags" class="tag-group" style="display: none;">
                <h4>Technology</h4>
                <div class="tags"></div>
            </div>
            <div id="business-tags" class="tag-group" style="display: none;">
                <h4>Business</h4>
                <div class="tags"></div>
            </div>
            <div id="language-tags" class="tag-group" style="display: none;">
                <h4>Language</h4>
                <div class="tags"></div>
            </div>
            <div id="design-tags" class="tag-group" style="display: none;">
                <h4>Design</h4>
                <div class="tags"></div>
            </div>
            <div id="skills-tags" class="tag-group" style="display: none;">
                <h4>Skills</h4>
                <div class="tags"></div>
            </div>
        </div>

        <div class="form-group">
            <h3>Existing Tags</h3>
            <div id="tags-list" class="mt-2">
                {% if tags_list|length == 0 %}
                    <p>Not have any tags in this course.</p>
                {% else %}
                    {% for tag in tags_list %}
                        <span class="badge badge-info mr-1">
                            {{ tag }}
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeTag('{{ forloop.counter0 }}')">X</button>
                        </span>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <div class="form-group">
            <h3>Existing Prerequisite Courses</h3>
            {% if prerequisites %}
                <ul>
                    {% for prereq in prerequisites %}
                    <li>
                        {{ prereq.course_name }}
                        <input type="checkbox" name="delete_prerequisite_{{ prereq.id }}" id="delete_prerequisite_{{ prereq.id }}">
                        <label for="delete_prerequisite_{{ prereq.id }}">Delete</label>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No prerequisites added.</p>
            {% endif %}
        </div>

        <div class="form-group" id="prerequisite-container">
            <h3>Add New Prerequisite Courses</h3>
            <div class="prerequisite-dropdown">
                <select name="prerequisite_courses" class="form-control">
                    <option value="">Select a prerequisite course</option>
                    {% for course in all_courses %}
                        <option value="{{ course.id }}">{{ course.course_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" id="add-prerequisite">Add Another Prerequisite Course</button>

        <div class="form-group">
            <h3>Manage Sessions</h3>
            {% for session in sessions %}
                <div class="session-group">
                    <label>Session Name:</label>
                    <input type="hidden" name="session_ids" value="{{ session.id }}">
                    <input type="text" name="session_names" class="form-control" value="{{ session.name }}">
                    <input type="checkbox" name="delete_session_ids" value="{{ session.id }}">
                    <label for="delete_session_ids">Delete Session</label>
                </div>
            {% empty %}
                <p>No sessions added yet.</p>
            {% endfor %}
        </div>

        <!-- Add New Sessions -->
        <div class="form-group">
            <h3>Add New Sessions</h3>
            <div id="new-session-container">
                <div class="session-group">
                    <input type="text" name="new_session_names" class="form-control" placeholder="New Session Name">
                </div>
            </div>
            <button type="button" class="btn btn-secondary" id="add-new-session">Add Another Session</button>
        </div>

        <div class="mb-4 mt-3">
            {% if sessions %}
                <a href="{% url 'course:course_content_edit' course.pk sessions.0.id %}" class="btn btn-primary">Edit Course Content</a>
                <a href="{% url 'course:reorder_course_materials' course.pk sessions.0.id %}" class="btn btn-primary">Edit Course Order</a>
            {% else %}
                <span>No sessions available.</span>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{% url 'course:course_list' %}" class="btn btn-secondary">Return to Course List</a>
    </form>
</div>

<script>
    const tags = [];

    document.querySelectorAll('#tags-list .badge').forEach(tagElement => {
        const tagText = tagElement.childNodes[0].nodeValue.trim();
        tags.push(tagText.toUpperCase());
    });

    // 14/10/2024 bên dưới phần doc trên xóa nha, nhớ là bên dưới nó nhiều lắm ấy check kĩ
    const tagsContainer = document.getElementById('tags-container');
    const tagsByTopic = {
        technology: ['AI', 'Web Development', 'Data Science', 'Machine Learning',
        'Cybersecurity', 'Blockchain', 'Internet of Things (IoT)', 'Cloud Computing', 'Big Data',
        'Augmented Reality (AR)', 'Virtual Reality (VR)', 'Robotics', '5G Technology', 'Quantum Computing',
        'Software Development', 'Mobile App Development', 'DevOps', 'Digital Transformation', 'E-commerce',
        'Fintech']
        ,
        business: ['Finance', 'Management', 'Marketing', 'Economics', 'Entrepreneurship',
        'Accounting', 'Human Resources', 'Business Strategy', 'Sales', 'Customer Service',
        'Project Management', 'Business Analytics', 'Supply Chain Management', 'Leadership',
        'Corporate Social Responsibility', 'Negotiation', 'Startups', 'Business Development', 'Innovation', 'Investment']
,
        language: ['English', 'French', 'Spanish', 'German', 'Mandarin', 'Japanese',
        'Korean', 'Italian', 'Portuguese', 'Russian', 'Arabic', 'Hindi', 'Dutch',
        'Greek', 'Turkish', 'Vietnamese', 'Swedish', 'Danish', 'Norwegian', 'Thai']
        ,
        design: ['UI', 'UX', 'Graphic Design', '3D Modeling', 'Animation', 'Illustration',
        'Interior Design', 'Fashion Design', 'Web Design', 'Product Design', 'Industrial Design',
        'Typography', 'Branding', 'Motion Graphics', 'Visual Design', 'Packaging Design', 'Game Design',
        'Architectural Design', 'Photography', 'Art Direction', 'Landscape Design']
        ,
        skills: ['Leadership', 'Communication', 'Time Management', 'Teamwork', 'Problem-Solving',
        'Critical Thinking', 'Adaptability', 'Creativity', 'Emotional Intelligence', 'Conflict Resolution',
        'Decision-Making', 'Public Speaking', 'Negotiation', 'Project Management', 'Networking',
        'Customer Service', 'Technical Writing', 'Coaching', 'Mentoring', 'Self-Motivation']

    };

    function updateTagsDropdown() {
    const selectedTopics = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(checkbox => checkbox.value);
    tagsContainer.style.display = selectedTopics.length > 0 ? 'block' : 'none'; // Show or hide the tags container
    Object.keys(tagsByTopic).forEach(topic => {
        const tagGroup = document.getElementById(`${topic}-tags`);
        const tagsDiv = tagGroup.querySelector('.tags');
        tagsDiv.innerHTML = ''; // Clear existing tags
        tagGroup.style.display = selectedTopics.includes(topic) ? 'block' : 'none'; // Show or hide the topic group

        if (selectedTopics.includes(topic)) {
            tagsByTopic[topic].forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'badge badge-info mr-1';
                tagElement.textContent = tag;
                tagElement.onclick = () => addTag(tag); // Add tag on click

                // Check if the tag is already selected
                if (tags.includes(tag.toUpperCase())) {
                    tagElement.classList.add('selected-tag');
                }

                tagsDiv.appendChild(tagElement); // Append the tag to the topic group
            });
        }
    });
}

    function addTag(tag) {
        const tagUpper = tag.toUpperCase();
        if (!tags.includes(tagUpper)) { // Prevent duplicates
            tags.push(tagUpper);
            updateTagsList(); // Update the displayed list of tags
        }
        updateTagsDropdown(); // Refresh tags dropdown to apply the selected-tag class
    }

    function removeTag(index) {
        // Remove the tag from the tags array
        tags.splice(index, 1);
        updateTagsList(); // Update the displayed list of tags
        updateTagsDropdown(); // Refresh tags dropdown to remove the selected-tag class
    }


    function updateTagsList() {
        const tagsList = document.getElementById('tags-list');
        tagsList.innerHTML = ''; // Clear existing tags
        tags.forEach((tag, index) => {
            const tagElement = document.createElement('span');
            tagElement.className = 'badge badge-info mr-1';
            tagElement.textContent = tag;

            // Create a remove button for each tag
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'btn btn-danger btn-sm ml-1';
            removeButton.textContent = 'X';
            removeButton.onclick = () => removeTag(index); // Pass the index to removeTag

            tagElement.appendChild(removeButton); // Append the button to the tag
            tagsList.appendChild(tagElement); // Append the tag to the list
        });
        updateTagsInput(); // Update the hidden input with the current tags
    }

    function updateTagsInput() {
        // Update the hidden input with the current tags
        document.getElementById('tags-input').value = tags.join(',');
    }

    // Event listener for checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', updateTagsDropdown);
    });

    document.getElementById('add-prerequisite').addEventListener('click', function() {
        var container = document.getElementById('prerequisite-container');
        var newDropdown = document.createElement('div');
        newDropdown.classList.add('prerequisite-dropdown');
        newDropdown.innerHTML = `
            <select name="prerequisite_courses" class="form-control">
                <option value="">Select a prerequisite course</option>
                {% for course in all_courses %}
                    <option value="{{ course.id }}">{{ course.course_name }}</option>
                {% endfor %}
            </select>
        `;
        container.appendChild(newDropdown);
    });

    document.getElementById('add-new-session').addEventListener('click', function() {
        var container = document.getElementById('new-session-container');
        var newInput = document.createElement('div');
        newInput.classList.add('session-group');
        newInput.innerHTML = `
            <input type="text" name="new_session_names" class="form-control" placeholder="New Session Name">
        `;
        container.appendChild(newInput);
    });
</script>

<style>
    .selected-tag {
        background-color: lightgray;
        color: #000;
    }
</style>

{% endblock %}