{% extends 'base.html' %}
{% load form_filters %}

{% block title %}Edit {{ course.course_name }}{% endblock %}

{% block content %}
<div class="container">
    <h1>Edit {{ course.course_name }}</h1>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="form-group">
            {{ course_form.course_name.label_tag }}
            {{ course_form.course_name|add_class:"form-control" }}
        </div>
        <div class="form-group">
            {{ course_form.course_code.label_tag }}
            {{ course_form.course_code|add_class:"form-control" }}
        </div>
        <div class="form-group">
            {{ course_form.description.label_tag }}
            {{ course_form.description|add_class:"form-control" }}
        </div>
        <div class="form-group">
            {{ course_form.instructor.label_tag }}
            {{ course_form.instructor|add_class:"form-control" }}
        </div>

         <!-- Topic Dropdown -->
         <div class="form-group">
            <label for="topic">Choose a Topic:</label>
            <select id="topic" name="topic" class="form-control">
                <option value="">Select a Topic</option>
                {% for topic in topics %}
                    <option value="{{ topic.id }}">{{ topic.name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Tags Checkboxes (This will be updated based on the selected topic) -->
        <div class="form-group" id="tags-container">
            <h3>Tags</h3>
            <div id="tags-list">
                <!-- Tags will be populated here based on the selected topic -->
            </div>
        </div>

        <!-- Existing Tags Section -->
        <div class="form-group">
            <h3>Current Existing Tags</h3>
            {% if course.tags.all %}
                <ul id="current-tags">
                    {% for tag in course.tags.all %}
                        <li>
                            {{ tag.name }}
                            <input type="checkbox" name="delete_tag_{{ tag.id }}" id="delete_tag_{{ tag.id }}">
                            <label for="delete_tag_{{ tag.id }}">Delete</label>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No tags added yet.</p>
            {% endif %}
        </div>

        <div class="form-group">
            <h3>Existing Prerequisite Courses</h3>
            {% if prerequisites %}
                <ul>
                    {% for prereq in prerequisites %}
                    <li>
                        {{ prereq.course_name }}
                        <input type="checkbox" name="delete_prerequisite_{{ prereq.id }}" id="delete_prerequisite_{{ prereq.id }}">
                        <label for="delete_prerequisite_{{ prereq.id }}">Delete</label>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>No prerequisites added.</p>
            {% endif %}
        </div>

        <div class="form-group" id="prerequisite-container">
            <h3>Add New Prerequisite Courses</h3>
            <div class="prerequisite-dropdown">
                <select name="prerequisite_courses" class="form-control">
                    <option value="">Select a prerequisite course</option>
                    {% for course in all_courses %}
                        <option value="{{ course.id }}">{{ course.course_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <button type="button" class="btn btn-secondary" id="add-prerequisite">Add Another Prerequisite Course</button>

        <div class="form-group">
            <h3>Manage Sessions</h3>
            {% for session in sessions %}
                <div class="session-group">
                    <label>Session Name:</label>
                    <input type="hidden" name="session_ids" value="{{ session.id }}">
                    <input type="text" name="session_names" class="form-control" value="{{ session.name }}">
                    <input type="checkbox" name="delete_session_ids" value="{{ session.id }}">
                    <label for="delete_session_ids">Delete Session</label>
                </div>
            {% empty %}
                <p>No sessions added yet.</p>
            {% endfor %}
        </div>

        <!-- Add New Sessions -->
        <div class="form-group">
            <h3>Add New Sessions</h3>
            <div id="new-session-container">
                <div class="session-group">
                    <input type="text" name="new_session_names" class="form-control" placeholder="New Session Name">
                </div>
            </div>
            <button type="button" class="btn btn-secondary" id="add-new-session">Add Another Session</button>
        </div>

        <div class="mb-4 mt-3">
            {% if sessions %}
                <a href="{% url 'course:course_content_edit' course.pk sessions.0.id %}" class="btn btn-primary">Edit Course Content</a>
                <a href="{% url 'course:reorder_course_materials' course.pk sessions.0.id %}" class="btn btn-primary">Edit Course Order</a>
            {% else %}
                <span>No sessions available.</span>
            {% endif %}
        </div>

        <!-- Image upload and deletion -->
        <div class="form-group">
            <h3>Course Image</h3>
            {% if course.image %}
                <img src="{{ course.image.url }}" alt="{{ course.course_name }}" style="max-width: 200px;">
                <br>
                <label>
                    <input type="checkbox" name="delete_image" value="on"> Delete existing image
                </label>
            {% else %}
                <p>No image uploaded yet.</p>
            {% endif %}
            <br>
            {{ course_form.image.label_tag }}
            {{ course_form.image|add_class:"form-control-file" }}
        </div>

        <button type="submit" class="btn btn-primary">Save Changes</button>
        <a href="{% url 'course:course_list' %}" class="btn btn-secondary">Return to Course List</a>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tags = [
            {% for tag in tags %}
            { id: "{{ tag.id }}", name: "{{ tag.name }}", topicId: "{{ tag.topic.id }}" },
            {% endfor %}
        ];

        // Create a set of current tag IDs for easy lookup
        const currentTags = new Set([
            {% for current_tag in course.tags.all %}
            "{{ current_tag.id }}",
            {% endfor %}
        ]);

        const topicSelect = document.getElementById('topic');
        const tagsListContainer = document.getElementById('tags-list');
        const form = document.querySelector('form');

        // Hidden input to store selected tag IDs
        const selectedTagsInput = document.createElement('input');
        selectedTagsInput.type = 'hidden';
        selectedTagsInput.name = 'selected_tags';
        form.appendChild(selectedTagsInput);

        // When the topic changes, update the tags
        topicSelect.addEventListener('change', function() {
            const selectedTopicId = this.value;
            tagsListContainer.innerHTML = '';

            if (selectedTopicId) {
                const filteredTags = tags.filter(tag => tag.topicId === selectedTopicId && !currentTags.has(tag.id));
                filteredTags.forEach(tag => {
                    const tagCheckbox = document.createElement('div');
                    tagCheckbox.innerHTML = `
                        <input type="checkbox" name="tags" class="tag-checkbox" value="${tag.id}" id="tag_${tag.id}">
                        <label for="tag_${tag.id}">${tag.name}</label>
                    `;
                    tagsListContainer.appendChild(tagCheckbox);
                });
            }
        });

        // Collect selected tag IDs before form submission
        form.addEventListener('submit', function() {
            const selectedTagIds = Array.from(tagsListContainer.querySelectorAll('.tag-checkbox:checked'))
                .map(checkbox => checkbox.value);
            selectedTagsInput.value = selectedTagIds.join(',');
        });
    });

    document.getElementById('add-prerequisite').addEventListener('click', function() {
        var container = document.getElementById('prerequisite-container');
        var newDropdown = document.createElement('div');
        newDropdown.classList.add('prerequisite-dropdown');
        newDropdown.innerHTML = `
            <select name="prerequisite_courses" class="form-control">
                <option value="">Select a prerequisite course</option>
                {% for course in all_courses %}
                    <option value="{{ course.id }}">{{ course.course_name }}</option>
                {% endfor %}
            </select>
        `;
        container.appendChild(newDropdown);
    });

    document.getElementById('add-new-session').addEventListener('click', function() {
        var container = document.getElementById('new-session-container');
        var newInput = document.createElement('div');
        newInput.classList.add('session-group');
        newInput.innerHTML = `
            <input type="text" name="new_session_names" class="form-control" placeholder="New Session Name">
        `;
        container.appendChild(newInput);
    });
</script>
{% endblock %}
