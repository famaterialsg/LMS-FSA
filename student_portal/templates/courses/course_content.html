{% extends 'basePortal.html' %}
{% load form_filters %}
{% load static %}

{% block title %}Course Content{% endblock %}

</style>>
{% block content %}

<div class="container-fluid">
    <div class="row vh-60">
        <!-- Sidebar Navigation - slightly shorter than full height -->
        <aside class="col-md-2 bg-dark text-white d-flex flex-column p-0 shadow-sm rounded-3" style="height: calc(100vh - 80px);">
            <!-- Course Title -->
            <div class="bg-black bg-opacity-25 border-bottom border-secondary border-opacity-10 position-sticky top-0 z-1 rounded-top">
                <div class="text-center py-3 d-flex align-items-center justify-content-center px-2">
                    <i class="fas fa-book-open me-2 fs-5 text-white"></i>
                    <span class="fs-5 fw-semibold text-white" style="white-space: normal;">{{ course.course_name }}</span>
                </div>
            </div>

            <!-- Scrollable Lessons Section - fills remaining height -->
            <div id="lesson-scroll" class="overflow-auto small flex-grow-1 px-1">
                <ul class="nav flex-column g-0">
                    {% for session in sessions %}
                    <li class="nav-item mb-1">
                        <!-- Session Header -->
                        <a title="{{ session.name }}"
                           class="nav-link text-white d-flex align-items-center py-2 px-2 rounded-2 {% if session.id == current_session.id %}bg-primary bg-opacity-75{% else %}text-light hover-bg-light hover-bg-opacity-10{% endif %}"
                           href="{% url 'student_portal:course_content' course.pk session.id %}">
                            <i class="fas fa-folder{% if session.id == current_session.id %}-open{% endif %} fa-xs me-2 text-warning opacity-75"></i>
                            <span class="text-truncate fw-semibold">{{ session.name }}</span>
                            {% if session.id == current_session.id %}
                            <i class="fas fa-chevron-down fa-xs ms-auto"></i>
                            {% endif %}
                        </a>

                        <!-- Materials List -->
                        <ul class="nav flex-column ms-3 mt-1">
                            {% for material in materials %}
                                {% if material.session.id == session.id %}
                                <li>
                                    <a title="{{ material.title }}"
                                       class="nav-link d-flex align-items-center py-1 px-2 rounded-2 {% if material.id == current_material.id %}text-white bg-primary bg-opacity-50{% else %}text-light text-opacity-75 hover-bg-light hover-bg-opacity-10{% endif %}"
                                       href="{% url 'student_portal:course_content' course.pk session.id %}?file_id={{ material.id }}&file_type={{ material.material_type }}">
                                        <i class="fas fa-xs me-2 {% if material.material_type == 'lecture' %}fa-play-circle text-info
                                                  {% elif material.material_type == 'assignment' %}fa-tasks text-warning
                                                  {% elif material.material_type == 'quiz' %}fa-question-circle text-danger
                                                  {% elif material.material_type == 'resource' %}fa-file-alt text-success
                                                  {% else %}fa-file-alt text-secondary{% endif %}"></i>
                                        <span class="text-truncate small">{{ material.title }}</span>
                                    </a>
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="col-md-10 d-flex flex-column p-3">
            <div id="message-content" class="alert alert-info d-none">
                <h5>Course Completion Progress</h5>
                <p>{{ completion_percent|floatformat:0 }}% completed</p>
                {% if certificate_url %}
                <div class="mt-3">
                    <button id="view-certificate" class="btn btn-primary">View Certificate</button>
                    <a href="{{ certificate_url }}" class="btn btn-success" download>Download Certificate</a>
                </div>
                {% endif %}
            </div>

            <div class="card shadow mb-4">
                <div class="card-header d-flex justify-content-between">
                    <h5>{{ current_material.title }}</h5>
                    <span class="badge bg-secondary">{{ current_material.material_type|title }}</span>
                </div>
                <div class="card-body" style="max-height: 70vh; overflow-y: auto;">
                    {% if content_type in 'assignments labs lectures references' %}
                        {{ preview_content|safe }}
                    {% else %}
                        <p class="text-muted fst-italic">No preview available for this material.</p>
                    {% endif %}
                </div>
            </div>

            <!-- <div class="d-flex justify-content-end gap-3">
                <a href="{% url 'student_portal:course_detail' course.id %}" class="btn btn-outline-secondary">Back to Course Detail</a>
                <button id="complete-btn"
                        class="btn {% if completion_status %}btn-secondary{% else %}btn-success{% endif %}"
                        data-course-id="{{ course.pk }}"
                        data-file-id="{{ current_material.id }}">
                    {% if completion_status %}Completed{% else %}Mark as Complete{% endif %}
                </button>
                {% if next_material or next_session %}
                <a href="{% if next_session %}{% url 'student_portal:course_content' course.pk next_session.id %}{% else %}{% url 'student_portal:course_content' course.pk current_session.id %}?file_id={{ next_material.id }}&file_type={{ next_material.material_type }}{% endif %}"
                   class="btn btn-outline-primary">
                    {% if next_session %}Next Session{% else %}Next Item{% endif %}
                </a>
                {% endif %}
            </div> -->

            {% if current_material %}
            <div class="mt-3" id="action-buttons"> <!-- Add an ID for easy manipulation -->
                <button id="complete-btn" class="btn {% if completion_status %}btn-secondary{% else %}btn-success{% endif %}" data-course-id="{{ course.pk }}" data-file-id="{{ current_material.id }}">
                    {% if completion_status %}Completed{% else %}Mark as Complete{% endif %}
                </button>
                {% if next_material or next_session %}
                <a id="next-btn" href="{% if next_session %}{% url 'student_portal:course_content' course.pk next_session.id %}?file_id={{ next_material.id }}&file_type={{ next_material.material_type }}{% else %}{% url 'student_portal:course_content' course.pk current_session.id %}?file_id={{ next_material.id }}&file_type={{ next_material.material_type }}{% endif %}" class="btn btn-secondary" style="background-color: gray;">
                    {% if next_session %}Next Session{% else %}Next Item{% endif %}
                </a>
                {% endif %}

                <a href="{% url 'student_portal:course_detail' course.id %}" class="btn btn-outline-secondary" style="background-color: gray;">Back to Course Detail</a>
            </div>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
    const lessonList = document.getElementById("lesson-list");
    const scrollUp = document.getElementById("scroll-up");
    const scrollDown = document.getElementById("scroll-down");

    // Scroll up
    scrollUp.addEventListener("click", () => {
        lessonList.scrollBy({ top: -100, behavior: "smooth" });
    });

    // Scroll down
    scrollDown.addEventListener("click", () => {
        lessonList.scrollBy({ top: 100, behavior: "smooth" });
    });
});
</script>
<script>
$(document).ready(function() {
    function getCSRFToken() {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === 'csrftoken=') {
                    cookieValue = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookieValue;
    }


    // Function to save end time when navigating away from the page
    function saveEndTimeOnNavigation(materialId) {
        if (materialId) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "student_portal:end_viewing_ajax" %}', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', getCSRFToken());  // Add CSRF token here
            xhr.send(JSON.stringify({
                'material_id': materialId
            }));
        }
    }

    function saveLastAccessedMaterial(materialId) {
        var courseId = '{{ course.pk }}';  // Assuming you have the course ID in your template context
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '{% url "student_portal:save_last_accessed_material" %}', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.setRequestHeader('X-CSRFToken', getCSRFToken());
        xhr.send(JSON.stringify({
            'material_id': materialId,
            'course_id': courseId  // Include course_id in the request
        }));
    }

    // Handle navigation away (on link click)
    $(document).on('click', '.nav-link, .list-group-item a, .btn-outline-secondary', function(e) {
        var materialId = '{{ current_material.id }}'; // Get current material id
        saveEndTimeOnNavigation(materialId); // Send end time on material navigation
        saveLastAccessedMaterial(materialId);
    });

    // Handle page unload (when leaving or refreshing the page)
    window.addEventListener('beforeunload', function(event) {
        var materialId = '{{ current_material.id }}'; // Get current material ID
        if (materialId) {
            // Make an AJAX request to save the end time before leaving the page
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '{% url "student_portal:end_viewing_ajax" %}', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.setRequestHeader('X-CSRFToken', getCSRFToken());  // Add CSRF token here
            xhr.send(JSON.stringify({
                'material_id': materialId
            }));
        }
    });
    // Ensure the session tabs are visible
    // $('#session-tabs').show();

    $('.materials-list').click(function() {
        $('#session-menu').toggle(); // Toggle materials list
        $('.message-content').hide(); // Hide Course Completion Progress
        $('.materials-list').show(); // Show materials list
        $('#action-buttons').show(); // Show action buttons
    });

    // Toggle visibility for Message content
    $('#message-tab').click(function() {
        $('#session-menu').hide(); // Hide materials list
        $('.materials-list').hide(); // Hide materials list
        $('.message-content').toggle(); // Toggle Course Completion Progress
        $('#action-buttons').hide(); // Hide action buttons
    });

    // Certificate functionality
    $('#view-certificate').click(function() {
        var certificateUrl = "{{ certificate_url }}";
        if (certificateUrl) {
            window.open(certificateUrl, '_blank');
        }
    });

    // Handle completion button click
    $('#complete-btn').click(function() {
        var button = $(this);
        var courseId = button.data('course-id');
        var fileId = button.data('file-id');

        $.ajax({
            url: "{% url 'course:toggle_completion' course.pk %}",
            method: 'POST',
            data: {
                'file_id': fileId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.completed) {
                    button.text('Completed');
                    button.removeClass('btn-success').addClass('btn-secondary');
                } else {
                    button.text('Mark as Complete');
                    button.removeClass('btn-secondary').addClass('btn-success');
                }
                // Reload page after updating status
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                alert("An error occurred: " + xhr.responseText);  // Add alert for better visibility
            }
        });
    });

    // Add iframe resizing logic here
    $('iframe').css({
        'width': '65rem',
        'height': '37rem',
        'border': 'none'
    });
});
</script>
{% endblock %}
