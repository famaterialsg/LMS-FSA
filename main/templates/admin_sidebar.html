{% load get_item %}
    <!-- Sidebar -->
    <style>
        /* Custom active class styling */
        .nav-link.active {
            color: #ffffff !important;
            background-color: #0d6efd !important; /* Dark background for active links */
        }
        /* Ẩn tên nhóm khi sidebar thu gọn */
        .sidebar-collapsed .module-name {
            display: none;
        }
        /* Ẩn nhóm module khi sidebar thu gọn */
        .sidebar-collapsed .sidebar-expanded {
            display: none;
        }
        /* Ẩn sidebar khi trạng thái hidden */
        .sidebar-hidden {
            display: none !important;
        }

        /* Hiển thị nhóm module khi sidebar mở rộng */
        .sidebar-expanded .sidebar-collapsed {
            display: none;
        }

        /* Hiển thị danh sách module đơn lẻ khi sidebar thu gọn */
        .sidebar-collapsed .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* Ẩn sidebar-collapsed khi mở rộng */
        .sidebar-expanded .sidebar-collapsed {
            display: none;
        }

        /* Ẩn sidebar-expanded khi thu gọn */
        .sidebar-collapsed .sidebar-expanded {
            display: none;
        }

        /* Kiểm soát hiển thị icon module khi thu gọn */
        .sidebar-collapsed .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Ẩn tên nhóm và module khi thu gọn */
        .sidebar-collapsed .module-name {
            display: none;
        }

        /* Hiển thị đầy đủ khi mở rộng */
        .sidebar-expanded .module-name {
            display: inline-block;
        }
        
    </style>
<ul class="nav flex-column">
    {% if user.is_authenticated %}
        <!-- Hiển thị khi sidebar mở rộng -->
        <div class="sidebar-expanded">
            {% for group in module_groups %}
                {% if grouped_modules|get_item:group %}
                    <li class="nav-item module-group">
                        <a class="nav-link text-light d-flex align-items-center" href="#group-{{ group.id }}" 
                            data-bs-toggle="collapse" role="button"
                            aria-expanded="{% if group.modules.all.0.module_url == active_module_url %}true{% else %}false{% endif %}" 
                            aria-controls="group-{{ group.id }}">
                            <i class="fas fa-caret-right me-2" id="icon-{{ group.id }}"></i>
                            <span class="module-name">{{ group.group_name }}</span>
                        </a>
                        <ul class="collapse list-unstyled ps-4" id="group-{{ group.id }}">
                            {% for module in grouped_modules|get_item:group %}
                                <li class="nav-item">
                                    <a class="nav-link text-light {% if module.module_url == active_module_url %}active{% endif %}" href="{% url module.module_url %}">
                                        <i class="{{ module.icon }}"></i>
                                        <span class="module-name">{{ module.module_name }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Hiển thị khi sidebar thu gọn -->
        <div class="sidebar-collapsed">
            <ul class="nav flex-column">
                {% for group in module_groups %}
                    {% for module in grouped_modules|get_item:group %}
                        <li class="nav-item text-center">
                            <a class="nav-link text-light {% if module.module_url == active_module_url %}active{% endif %}" 
                            href="{% url module.module_url %}">
                                <i class="{{ module.icon }}" style="font-size: 4vh;"></i> <!-- Icon module -->
                                <span class="module-name d-block mt-1" style="font-size: 1vh;">{{ module.module_name }}</span> <!-- Tên module -->
                            </a>
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>

    {% endif %}
</ul>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');
        const mainContentArea = document.getElementById('mainContentArea');
        const toggleButton = document.getElementById('sidebarToggle');
    
        // Lấy trạng thái sidebar từ LocalStorage (mặc định là mở rộng nếu không có giá trị nào được lưu)
        let sidebarState = JSON.parse(localStorage.getItem('sidebarState')) || 'expanded'; // expanded, collapsed, hidden
    
        // Hàm cập nhật trạng thái sidebar
        function updateSidebarState() {
            if (sidebarState === 'expanded') {
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.width = '15vw';
                mainContentArea.classList.add('col-md-10', 'offset-md-2');
                mainContentArea.classList.remove('col-md-11', 'offset-md-1','col-md-12','col-md-11','offset-md-1');
                sidebar.classList.remove('sidebar-collapsed', 'sidebar-hidden');
                sidebar.classList.add('sidebar-expanded');
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>'; // Icon cho mở rộng
            } else if (sidebarState === 'collapsed') {
                sidebar.style.transform = 'translateX(0)';
                sidebar.style.width = '8vw';
                mainContentArea.classList.add('col-md-11', 'offset-md-1');
                mainContentArea.classList.remove('col-md-10', 'offset-md-2','col-md-12');
                sidebar.classList.add('sidebar-collapsed');
                sidebar.classList.remove('sidebar-expanded', 'sidebar-hidden');
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>'; // Icon cho thu gọn
            } else if (sidebarState === 'hidden') {
                sidebar.style.transform = 'translateX(-100%)';
                sidebar.style.width = '0';
                mainContentArea.classList.add('col-md-12');
                mainContentArea.classList.remove('col-md-10', 'offset-md-2', 'col-md-11', 'offset-md-1');
                sidebar.classList.add('sidebar-hidden');
                sidebar.classList.remove('sidebar-expanded', 'sidebar-collapsed');
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>'; // Icon cho tắt hẳn
            }
        }
    
        // Thiết lập trạng thái ban đầu
        updateSidebarState();
    
        // Xử lý sự kiện khi nhấn nút toggle
        toggleButton.addEventListener('click', function () {
            // Chuyển trạng thái xoay tua
            if (sidebarState === 'expanded') {
                sidebarState = 'collapsed';
            } else if (sidebarState === 'collapsed') {
                sidebarState = 'hidden';
            } else {
                sidebarState = 'expanded';
            }
            localStorage.setItem('sidebarState', JSON.stringify(sidebarState)); // Lưu trạng thái vào LocalStorage
            updateSidebarState(); // Cập nhật trạng thái
        });
    });
    
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const currentURL = window.location.pathname; // Lấy URL hiện tại
    
        // Kiểm tra và thêm lớp active cho sidebar mở rộng
        document.querySelectorAll('.sidebar-expanded .nav-link').forEach(function (link) {
            if (link.getAttribute('href') === currentURL) {
                link.classList.add('active'); // Thêm lớp active cho mục phù hợp
                link.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Cuộn đến mục active
            } else {
                link.classList.remove('active'); // Xóa lớp active nếu không phù hợp
            }
        });
    
        // Kiểm tra và thêm lớp active cho sidebar thu gọn
        document.querySelectorAll('.sidebar-collapsed .nav-link').forEach(function (link) {
            if (link.getAttribute('href') === currentURL) {
                link.classList.add('active'); // Thêm lớp active cho mục phù hợp
                link.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Cuộn đến mục active
            } else {
                link.classList.remove('active'); // Xóa lớp active nếu không phù hợp
            }
        });
    
        // Xử lý mở rộng nhóm chứa mục active trong sidebar mở rộng
        document.querySelectorAll('.sidebar-expanded .collapse').forEach(function (collapseElement) {
            const moduleLinks = collapseElement.querySelectorAll('.nav-link');
            let isActiveGroup = false;
    
            moduleLinks.forEach(function (moduleLink) {
                if (moduleLink.classList.contains('active')) {
                    isActiveGroup = true; // Đánh dấu nhóm chứa mục active
                }
            });
    
            if (isActiveGroup) {
                collapseElement.classList.add('show'); // Mở rộng nhóm
            }
        });
    });
</script>
<script>
    $(document).ready(function() {
        // Khi người dùng bấm vào module trong sidebar
        $("a.nav-link").on("click", function(event) {
            event.preventDefault(); // Ngừng hành động mặc định (điều hướng trang)
    
            var url = $(this).attr("href"); // Lấy URL của module
            var scrollPosition = $(window).scrollTop(); // Ghi lại vị trí cuộn hiện tại
    
            $.ajax({
                url: url, // Gửi yêu cầu đến URL của module
                type: "GET",
                data: {
                    'search': $('#search-input').val(), // Thêm tham số tìm kiếm nếu có
                    'group': $(this).data('group') // Thêm tham số group nếu cần
                },
                success: function(response) {
                    // Cập nhật nội dung của #mainContentArea mà không làm mới sidebar
                    $("#mainContentArea").html(response.html);
    
                    // Đặt lại vị trí cuộn ngay sau khi nội dung được cập nhật
                    $(window).scrollTop(scrollPosition);
                },
                error: function(xhr, status, error) {
                    console.log("Có lỗi khi tải nội dung: ", error);
                }
            });
        });
    });
    
</script>