{% load get_item %}
    <!-- Sidebar -->
    <style>
        /* Custom active class styling */
        .nav-link.active {
            color: #ffffff !important;
            background-color: #0d6efd !important; /* Dark background for active links */
        }
        /* Ẩn tên nhóm khi sidebar thu gọn */
        .sidebar-collapsed .module-name {
            display: none;
        }
        /* Ẩn nhóm module khi sidebar thu gọn */
        .sidebar-collapsed .sidebar-expanded {
            display: none;
        }
        /* Ẩn sidebar khi trạng thái hidden */
        .sidebar-hidden {
            display: none !important;
        }

        /* Hiển thị nhóm module khi sidebar mở rộng */
        .sidebar-expanded .sidebar-collapsed {
            display: none;
        }

        /* Hiển thị danh sách module đơn lẻ khi sidebar thu gọn */
        .sidebar-collapsed .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* Ẩn sidebar-collapsed khi mở rộng */
        .sidebar-expanded .sidebar-collapsed {
            display: none;
        }

        /* Ẩn sidebar-expanded khi thu gọn */
        .sidebar-collapsed .sidebar-expanded {
            display: none;
        }

        /* Kiểm soát hiển thị icon module khi thu gọn */
        .sidebar-collapsed .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        /* Ẩn tên nhóm và module khi thu gọn */
        .sidebar-collapsed .module-name {
            display: none;
        }

        /* Hiển thị đầy đủ khi mở rộng */
        .sidebar-expanded .module-name {
            display: inline-block;
        }
        #sidebar {
            visibility: hidden; /* Ẩn sidebar ban đầu */
        }
        
    </style>
<ul class="nav flex-column">
    {% if user.is_authenticated %}
        <!-- Hiển thị khi sidebar mở rộng -->
        <div class="sidebar-expanded">
            {% for group in module_groups %}
                {% if grouped_modules|get_item:group %}
                    <li class="nav-item module-group">
                        <a class="nav-link text-light d-flex align-items-center" href="#group-{{ group.id }}" 
                            data-bs-toggle="collapse" role="button"
                            aria-expanded="{% if group.modules.all.0.module_url == active_module_url %}true{% else %}false{% endif %}" 
                            aria-controls="group-{{ group.id }}">
                            <i class="fas fa-caret-right me-2" id="icon-{{ group.id }}"></i>
                            <span class="module-name">{{ group.group_name }}</span>
                        </a>
                        <ul class="collapse list-unstyled ps-4" id="group-{{ group.id }}">
                            {% for module in grouped_modules|get_item:group %}
                                <li class="nav-item">
                                    <a class="nav-link text-light {% if module.module_url == active_module_url %}active{% endif %}" href="{% url module.module_url %}">
                                        <i class="{{ module.icon }}"></i>
                                        <span class="module-name">{{ module.module_name }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    </li>
                {% endif %}
            {% endfor %}
        </div>

        <!-- Hiển thị khi sidebar thu gọn -->
        <div class="sidebar-collapsed">
            <ul class="nav flex-column">
                {% for group in module_groups %}
                    {% for module in grouped_modules|get_item:group %}
                        <li class="nav-item text-center">
                            <a class="nav-link text-light {% if module.module_url == active_module_url %}active{% endif %}" 
                            href="{% url module.module_url %}">
                                <i class="{{ module.icon }}" style="font-size: 4vh;"></i> <!-- Icon module -->
                                <span class="module-name d-block mt-1" style="font-size: 1vh;">{{ module.module_name }}</span> <!-- Tên module -->
                            </a>
                        </li>
                    {% endfor %}
                {% endfor %}
            </ul>
        </div>

    {% endif %}
</ul>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const sidebar = document.getElementById('sidebar');
        const mainContentArea = document.getElementById('mainContentArea');
        const toggleButton = document.getElementById('sidebarToggle');
    
        // Lấy trạng thái sidebar và mainContentArea từ LocalStorage
        let sidebarState = JSON.parse(localStorage.getItem('sidebarState')) || 'hidden';
        let mainContentAreaState = JSON.parse(localStorage.getItem('mainContentAreaState')) || 'col-md-12';

        // Hàm cập nhật trạng thái sidebar và mainContentArea
        function updateSidebarState() {
            if (sidebarState === 'expanded' && mainContentAreaState === 'col-md-10 offset-md-2') {
                sidebar.style.width = '15vw';
                mainContentArea.classList.add('col-md-10', 'offset-md-2');
                mainContentArea.classList.remove('col-md-11', 'offset-md-1', 'col-md-12');
                sidebar.classList.add('sidebar-expanded');
                sidebar.classList.remove('sidebar-collapsed', 'sidebar-hidden');
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>';
            } else if (sidebarState === 'collapsed' && mainContentAreaState === 'col-md-11 offset-md-1') {
                sidebar.style.width = '8vw';
                mainContentArea.classList.add('col-md-11', 'offset-md-1');
                mainContentArea.classList.remove('col-md-10', 'offset-md-2', 'col-md-12');
                sidebar.classList.add('sidebar-collapsed');
                sidebar.classList.remove('sidebar-expanded', 'sidebar-hidden');
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>';
            } else if (sidebarState === 'hidden' && mainContentAreaState === 'col-md-12') {
                sidebar.style.width = '0';
                mainContentArea.classList.add('col-md-12');
                mainContentArea.classList.remove('col-md-10', 'offset-md-2', 'col-md-11', 'offset-md-1');
                sidebar.classList.add('sidebar-hidden');
                sidebar.classList.remove('sidebar-expanded', 'sidebar-collapsed');
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>';
            }
    
            // Lưu trạng thái của sidebar và mainContentArea vào LocalStorage
            localStorage.setItem('sidebarState', JSON.stringify(sidebarState));
            localStorage.setItem('mainContentAreaState', JSON.stringify(mainContentAreaState));
        }
    
        // Cập nhật trạng thái ban đầu
        updateSidebarState();
    
        sidebar.style.visibility = 'visible';
        mainContentArea.style.visibility = 'visible';
    
        // Xử lý sự kiện khi nhấn nút toggle
        toggleButton.addEventListener('click', function () {
            if (sidebarState === 'expanded') {
                sidebarState = 'collapsed';
                mainContentAreaState = 'col-md-11 offset-md-1';
            } else if (sidebarState === 'collapsed') {
                sidebarState = 'hidden';
                mainContentAreaState = 'col-md-12';
            } else {
                sidebarState = 'expanded';
                mainContentAreaState = 'col-md-10 offset-md-2';
            }
    
            updateSidebarState();
        });

        // Xử lý các link active trong sidebar
        const currentURL = window.location.pathname; // Lấy URL hiện tại

        // Kiểm tra và thêm lớp active cho sidebar mở rộng
        document.querySelectorAll('.sidebar-expanded .nav-link').forEach(function (link) {
            if (link.getAttribute('href') === currentURL) {
                link.classList.add('active'); // Thêm lớp active cho mục phù hợp
                link.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Cuộn đến mục active
            } else {
                link.classList.remove('active'); // Xóa lớp active nếu không phù hợp
            }
        });

        // Kiểm tra và thêm lớp active cho sidebar thu gọn
        document.querySelectorAll('.sidebar-collapsed .nav-link').forEach(function (link) {
            if (link.getAttribute('href') === currentURL) {
                link.classList.add('active'); // Thêm lớp active cho mục phù hợp
                link.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Cuộn đến mục active
            } else {
                link.classList.remove('active'); // Xóa lớp active nếu không phù hợp
            }
        });

        // Xử lý mở rộng nhóm chứa mục active trong sidebar mở rộng
        document.querySelectorAll('.sidebar-expanded .collapse').forEach(function (collapseElement) {
            const moduleLinks = collapseElement.querySelectorAll('.nav-link');
            let isActiveGroup = false;

            moduleLinks.forEach(function (moduleLink) {
                if (moduleLink.classList.contains('active')) {
                    isActiveGroup = true; // Đánh dấu nhóm chứa mục active
                }
            });

            if (isActiveGroup) {
                collapseElement.classList.add('show'); // Mở rộng nhóm
            } else {
                collapseElement.classList.remove('show'); // Đóng nhóm nếu không có mục active
            }
        });

    });
</script>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Hàm sắp xếp các mục trong sidebar theo alphabet
        function sortSidebarItems() {
            document.querySelectorAll('.sidebar-collapsed ul').forEach(function (ul) {
                let items = Array.from(ul.children);

                // Sắp xếp các mục theo tên module (thứ tự alphabet)
                items.sort((a, b) => {
                    let nameA = a.querySelector('.module-name').innerText.toLowerCase();
                    let nameB = b.querySelector('.module-name').innerText.toLowerCase();
                    return nameA.localeCompare(nameB);
                });

                // Gắn lại từng item vào ul sau khi sắp xếp
                items.forEach(item => ul.appendChild(item));
            });
        }

        // Sắp xếp các mục ngay khi trang được tải
        sortSidebarItems();

        // Sau khi sắp xếp, nếu có module nào đã được active, chúng ta sẽ đảm bảo mục đó vẫn được active
        const currentURL = window.location.pathname; // Lấy URL hiện tại
        document.querySelectorAll('.sidebar-collapsed .nav-link').forEach(function (link) {
            if (link.getAttribute('href') === currentURL) {
                link.classList.add('active'); // Thêm lớp active cho mục phù hợp
                link.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Cuộn đến mục active
            }
        });
    });
</script>
